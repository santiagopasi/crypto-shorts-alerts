<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ff4757">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PasiAlerts">
  <title>Pasi Alerts - Futuros</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 50%, #0f0f1a 100%);
      min-height: 100vh;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.2rem;
      background: linear-gradient(90deg, #ff4757, #ff6b81);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #888;
      font-size: 1rem;
    }

    /* Settings Panel */
    .settings-panel {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }

    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setting-group label {
      font-size: 0.85rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .setting-group input, .setting-group select {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 12px 16px;
      color: #fff;
      font-size: 1rem;
      min-width: 150px;
    }

    .setting-group input:focus, .setting-group select:focus {
      outline: none;
      border-color: #ff4757;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff4757, #ff6b81);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 71, 87, 0.3);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }

    .btn-secondary.active {
      background: rgba(255, 71, 87, 0.2);
      border-color: #ff4757;
      color: #ff4757;
    }

    /* Stats */
    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 12px;
      padding: 20px 25px;
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 180px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .stat-value.danger { color: #ff4757; }
    .stat-value.warning { color: #ffa502; }
    .stat-value.success { color: #2ed573; }

    /* Table */
    .table-container {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .table-scroll {
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      position: relative;
      touch-action: pan-x pan-y;
      scrollbar-width: thin;
      scrollbar-color: #ff4757 #1a1a2e;
    }

    .table-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: #1a1a2e;
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: #ff4757;
      border-radius: 4px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .table-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .last-update {
      font-size: 0.85rem;
      color: #888;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 20px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: color 0.3s;
    }

    th:hover {
      color: #ff4757;
    }

    th.sorted {
      color: #ff4757;
    }

    td {
      padding: 18px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.95rem;
    }

    tr:hover {
      background: rgba(255, 71, 87, 0.05);
    }

    .symbol {
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .symbol-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff4757, #ff6b81);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .price {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }

    .change-positive {
      color: #2ed573;
      font-weight: 600;
    }

    .change-negative {
      color: #ff4757;
      font-weight: 600;
    }

    .volume {
      color: #ffa502;
    }

    .alert-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    .alert-badge.high {
      background: rgba(255, 71, 87, 0.2);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .alert-badge.medium {
      background: rgba(255, 165, 2, 0.2);
      color: #ffa502;
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .alert-badge.low {
      background: rgba(46, 213, 115, 0.2);
      color: #2ed573;
      border: 1px solid rgba(46, 213, 115, 0.3);
    }

    .signal-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .signal-badge.signal-short {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.2), rgba(192, 57, 43, 0.2));
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.4);
    }

    .signal-badge.signal-long {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(39, 174, 96, 0.2));
      color: #2ed573;
      border: 1px solid rgba(46, 213, 115, 0.4);
    }

    /* Funding rate styles */
    .funding-cell {
      cursor: pointer;
      transition: all 0.2s;
    }

    .funding-cell:hover {
      background: rgba(255,255,255,0.05);
    }

    .funding-good {
      color: #2ed573 !important;
      font-weight: 600;
    }

    .funding-bad {
      color: #ff4757 !important;
      font-weight: 600;
    }

    /* Funding Toast */
    .funding-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 25px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .funding-toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .funding-toast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .funding-toast-title {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .funding-toast-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .funding-toast-close:hover {
      background: rgba(255, 71, 87, 0.3);
    }

    .funding-toast-content {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #ccc;
    }

    .funding-toast-content strong {
      color: #fff;
    }

    .funding-toast-content .good {
      color: #2ed573;
      font-weight: 600;
    }

    .funding-toast-content .bad {
      color: #ff4757;
      font-weight: 600;
    }

    .funding-toast-content .highlight {
      color: #ffa502;
      font-weight: 600;
    }

    .funding-info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .funding-info-row:last-child {
      border-bottom: none;
    }

    .funding-info-label {
      color: #888;
    }

    .funding-info-value {
      font-weight: 600;
    }

    .funding-summary {
      margin-top: 15px;
      padding: 15px;
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .funding-summary.good-summary {
      background: rgba(46, 213, 115, 0.1);
      border: 1px solid rgba(46, 213, 115, 0.3);
    }

    .funding-summary.bad-summary {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    /* Score badge in table */
    .score-cell {
      cursor: help;
    }

    .score-badge-table {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      font-size: 0.95rem;
      font-weight: 700;
    }

    .score-badge-table.score-high {
      background: linear-gradient(135deg, #ff4757, #c0392b);
      color: #fff;
      box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
      animation: pulse-score 2s infinite;
    }

    .score-badge-table.score-medium {
      background: linear-gradient(135deg, #ffa502, #e67e22);
      color: #fff;
    }

    .score-badge-table.score-low {
      background: linear-gradient(135deg, #a29bfe, #6c5ce7);
      color: #fff;
    }

    .score-badge-table.score-minimal {
      background: rgba(255,255,255,0.1);
      color: #888;
      border: 1px solid rgba(255,255,255,0.2);
    }

    @keyframes pulse-score {
      0%, 100% { box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }
      50% { box-shadow: 0 0 25px rgba(255, 71, 87, 0.7); }
    }

    /* Data source footer */
    .data-source {
      padding: 15px 25px;
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
      text-align: center;
    }

    .data-source p {
      font-size: 0.8rem;
      color: #888;
      margin: 0;
    }

    .data-source a {
      color: #a29bfe;
      text-decoration: none;
      transition: color 0.2s;
    }

    .data-source a:hover {
      color: #6c5ce7;
      text-decoration: underline;
    }

    .data-source-note {
      margin-top: 8px !important;
      font-size: 0.75rem !important;
      color: #666 !important;
    }

    /* Help button */
    .help-btn {
      padding: 10px 18px;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .help-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
    }

    /* Help Modal */
    .help-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .help-modal-overlay.show {
      display: flex;
    }

    .help-modal {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
    }

    .help-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      z-index: 10;
    }

    .help-modal-header h2 {
      font-size: 1.3rem;
      color: #fff;
      margin: 0;
    }

    .help-modal-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .help-modal-close:hover {
      background: rgba(255, 71, 87, 0.3);
    }

    .help-modal-content {
      padding: 25px;
    }

    .help-intro {
      background: rgba(108, 92, 231, 0.1);
      border: 1px solid rgba(108, 92, 231, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .help-intro p {
      margin: 0;
      color: #ccc;
      line-height: 1.6;
    }

    .help-step {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .help-step:last-of-type {
      border-bottom: none;
    }

    .help-step-number {
      width: 40px;
      height: 40px;
      min-width: 40px;
      background: linear-gradient(135deg, #F0B90B, #FCD535);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 700;
      color: #000;
    }

    .help-step-content {
      flex: 1;
    }

    .help-step-content h3 {
      color: #fff;
      font-size: 1.1rem;
      margin: 0 0 10px 0;
    }

    .help-step-content p {
      color: #aaa;
      font-size: 0.95rem;
      line-height: 1.6;
      margin: 8px 0;
    }

    .help-step-content ul, .help-step-content ol {
      color: #aaa;
      font-size: 0.95rem;
      line-height: 1.8;
      margin: 10px 0;
      padding-left: 20px;
    }

    .help-step-content li {
      margin: 5px 0;
    }

    .help-link {
      display: inline-block;
      background: linear-gradient(135deg, #F0B90B, #FCD535);
      color: #000;
      padding: 12px 20px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      margin: 10px 0;
      transition: all 0.2s;
    }

    .help-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(240, 185, 11, 0.4);
    }

    .help-note {
      font-size: 0.85rem !important;
      color: #888 !important;
      font-style: italic;
    }

    .help-warning {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
      border-radius: 8px;
      padding: 12px 15px;
      color: #ff6b81;
      font-size: 0.9rem;
      margin: 10px 0;
    }

    .help-security {
      background: rgba(46, 213, 115, 0.1);
      border: 1px solid rgba(46, 213, 115, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 25px 0;
    }

    .help-security h3 {
      color: #2ed573;
      margin: 0 0 15px 0;
      font-size: 1.1rem;
    }

    .help-security ul {
      color: #aaa;
      font-size: 0.9rem;
      line-height: 1.8;
      margin: 0;
      padding-left: 20px;
    }

    .help-footer {
      padding-top: 10px;
    }

    .new-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      background: linear-gradient(135deg, #a29bfe, #6c5ce7);
      color: #fff;
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .days-listed {
      font-size: 0.75rem;
      color: #888;
      margin-top: 2px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      background: rgba(255, 71, 87, 0.15);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    /* Alert popup */
    .alert-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #c0392b);
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(255, 71, 87, 0.4);
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }

    .alert-popup.hidden {
      display: none;
    }

    .alert-popup h4 {
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .alert-popup p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .alert-popup .close-alert {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .alert-popup .close-alert:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #ff4757;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .container {
        padding: 10px;
      }

      header {
        padding: 20px 10px;
      }

      h1 {
        font-size: 1.6rem;
      }

      .subtitle {
        font-size: 0.85rem;
      }

      .settings-panel {
        padding: 15px;
      }

      .settings-row {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .setting-group {
        width: 100%;
      }

      .setting-group input, .setting-group select {
        width: 100%;
      }

      .stats-bar {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        min-width: auto;
        padding: 15px;
      }

      .stat-value {
        font-size: 1.4rem;
      }

      .table-container {
        overflow: visible;
      }

      .table-scroll {
        overflow-x: scroll;
        display: block;
        width: 100%;
        max-width: 100vw;
        margin: 0 -15px;
        padding: 0 15px;
      }

      table {
        font-size: 0.75rem;
        min-width: 700px;
        display: table;
      }

      th, td {
        padding: 10px 8px;
        white-space: nowrap;
      }

      .symbol-icon {
        display: none;
      }

      .action-btn, .save-alert-btn {
        padding: 5px 8px;
        font-size: 0.7rem;
      }

      /* Bot section mobile */
      .bot-section {
        margin-top: 20px;
      }

      .bot-header {
        flex-direction: column;
        gap: 10px;
        padding: 15px;
      }

      .bot-title {
        font-size: 1rem;
      }

      .bot-tabs {
        flex-direction: column;
      }

      .bot-tab {
        padding: 12px 15px;
        font-size: 0.85rem;
      }

      .bot-content {
        padding: 15px;
      }

      .saved-alert-card {
        padding: 15px;
      }

      .saved-alert-header {
        flex-direction: column;
        gap: 12px;
      }

      .saved-alert-symbol {
        font-size: 1.1rem;
        flex-wrap: wrap;
      }

      .saved-alert-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 12px;
      }

      .saved-stat-value {
        font-size: 0.95rem;
      }

      .bot-analysis {
        padding: 15px;
      }

      .indicator-tags {
        gap: 5px;
      }

      .indicator-tag {
        padding: 4px 8px;
        font-size: 0.65rem;
      }

      /* Manual entry mobile */
      .manual-form-grid {
        grid-template-columns: 1fr;
      }

      .consult-input-row {
        flex-direction: column;
      }

      .consult-btn {
        width: 100%;
      }

      /* Database mobile */
      .db-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .db-stat {
        padding: 12px;
      }

      .db-stat-value {
        font-size: 1.2rem;
      }

      .success-db-item {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .success-db-stats {
        font-size: 0.75rem;
      }

      /* Consult result mobile */
      .consult-verdict {
        font-size: 1rem;
        flex-wrap: wrap;
      }

      .pattern-match-item {
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.3rem;
      }

      .stats-bar {
        grid-template-columns: 1fr 1fr;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-label {
        font-size: 0.65rem;
      }

      .stat-value {
        font-size: 1.2rem;
      }

      .saved-alert-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .score-badge {
        width: 35px;
        height: 35px;
        font-size: 0.85rem;
      }

      .new-badge {
        padding: 3px 6px;
        font-size: 0.6rem;
      }
    }

    /* Sound toggle */
    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .sound-toggle label {
      font-size: 0.9rem;
      color: #aaa;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.1);
      border-radius: 26px;
      transition: 0.3s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: #ff4757;
    }

    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(24px);
    }

    /* Bot Analyst Section */
    .bot-section {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 16px;
      margin-top: 30px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }

    .bot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      background: linear-gradient(135deg, rgba(108, 92, 231, 0.2), rgba(162, 155, 254, 0.1));
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .bot-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .bot-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .bot-content {
      padding: 25px;
    }

    .saved-alerts-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    .saved-alert-card {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      transition: all 0.3s;
    }

    .saved-alert-card:hover {
      border-color: rgba(108, 92, 231, 0.3);
    }

    .saved-alert-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .saved-alert-symbol {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .saved-alert-time {
      font-size: 0.8rem;
      color: #888;
    }

    .saved-alert-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .saved-stat {
      text-align: center;
    }

    .saved-stat-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .saved-stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 4px;
    }

    .bot-analysis {
      background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.05));
      border-radius: 10px;
      padding: 18px;
      border-left: 3px solid #6c5ce7;
    }

    .bot-analysis-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #a29bfe;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bot-analysis-text {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #ddd;
    }

    .bot-analysis-text strong {
      color: #ff4757;
    }

    .bot-analysis-text .positive {
      color: #2ed573;
    }

    .bot-analysis-text .warning {
      color: #ffa502;
    }

    .indicator-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .indicator-tag {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .indicator-tag.bearish {
      background: rgba(255, 71, 87, 0.2);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .indicator-tag.neutral {
      background: rgba(255, 165, 2, 0.2);
      color: #ffa502;
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .indicator-tag.info {
      background: rgba(108, 92, 231, 0.2);
      color: #a29bfe;
      border: 1px solid rgba(108, 92, 231, 0.3);
    }

    .save-alert-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(108, 92, 231, 0.2);
      color: #a29bfe;
      border: 1px solid rgba(108, 92, 231, 0.3);
      cursor: pointer;
      transition: all 0.3s;
    }

    .save-alert-btn:hover {
      background: #6c5ce7;
      color: #fff;
    }

    .save-alert-btn.saved {
      background: rgba(46, 213, 115, 0.2);
      color: #2ed573;
      border-color: rgba(46, 213, 115, 0.3);
    }

    .delete-alert-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(255, 71, 87, 0.1);
      color: #ff6b81;
      border: 1px solid rgba(255, 71, 87, 0.2);
      cursor: pointer;
      transition: all 0.3s;
    }

    .delete-alert-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    .empty-bot {
      text-align: center;
      padding: 50px 20px;
      color: #666;
    }

    .empty-bot svg {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    .clear-all-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      background: rgba(255, 71, 87, 0.1);
      color: #ff6b81;
      border: 1px solid rgba(255, 71, 87, 0.2);
      cursor: pointer;
    }

    .clear-all-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    /* Bot Tabs */
    .bot-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(0,0,0,0.3);
    }

    .bot-tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: #888;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 2px solid transparent;
    }

    .bot-tab:hover {
      color: #fff;
      background: rgba(255,255,255,0.05);
    }

    .bot-tab.active {
      color: #a29bfe;
      background: rgba(108, 92, 231, 0.1);
      border-bottom-color: #6c5ce7;
    }

    .bot-tab-content {
      display: none;
    }

    .bot-tab-content.active {
      display: block;
    }

    /* Consult section */
    .consult-section {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .consult-input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .consult-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 14px 18px;
      color: #fff;
      font-size: 1rem;
      text-transform: uppercase;
    }

    .consult-input:focus {
      outline: none;
      border-color: #6c5ce7;
    }

    .consult-input::placeholder {
      color: #666;
      text-transform: none;
    }

    .consult-btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .consult-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(108, 92, 231, 0.3);
    }

    .consult-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .consult-result {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 25px;
      display: none;
    }

    .consult-result.active {
      display: block;
    }

    .consult-verdict {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .consult-verdict.positive {
      color: #2ed573;
    }

    .consult-verdict.negative {
      color: #ff4757;
    }

    .consult-verdict.neutral {
      color: #ffa502;
    }

    .pattern-matches {
      margin-top: 20px;
    }

    .pattern-match-title {
      font-size: 0.9rem;
      color: #a29bfe;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .pattern-match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(108, 92, 231, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .pattern-similarity {
      font-weight: 600;
      color: #2ed573;
    }

    /* Success marking */
    .mark-success-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(46, 213, 115, 0.1);
      color: #2ed573;
      border: 1px solid rgba(46, 213, 115, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 8px;
    }

    .mark-success-btn:hover {
      background: #2ed573;
      color: #fff;
    }

    .mark-success-btn.marked {
      background: #2ed573;
      color: #fff;
    }

    /* Database stats */
    .db-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .db-stat {
      background: rgba(0,0,0,0.3);
      padding: 15px 20px;
      border-radius: 10px;
      text-align: center;
      min-width: 120px;
    }

    .db-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #a29bfe;
    }

    .db-stat-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* Success database list */
    .success-db-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .success-db-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(46, 213, 115, 0.05);
      border: 1px solid rgba(46, 213, 115, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .success-db-item-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .success-db-symbol {
      font-weight: 700;
      color: #2ed573;
    }

    .success-db-stats {
      font-size: 0.85rem;
      color: #888;
    }

    .remove-from-db-btn {
      padding: 5px 10px;
      background: rgba(255, 71, 87, 0.1);
      border: none;
      border-radius: 5px;
      color: #ff6b81;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .remove-from-db-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    /* Manual Entry Form */
    .manual-entry-section {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .manual-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(39, 174, 96, 0.05));
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #2ed573;
    }

    .manual-entry-header:hover {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.15), rgba(39, 174, 96, 0.1));
    }

    .toggle-icon {
      transition: transform 0.3s;
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .manual-entry-form {
      padding: 25px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .manual-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .manual-form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .manual-form-group label {
      font-size: 0.85rem;
      color: #aaa;
    }

    .manual-form-group input {
      text-transform: none;
    }

    .manual-form-note {
      background: rgba(108, 92, 231, 0.1);
      border-radius: 8px;
      padding: 12px 15px;
      font-size: 0.85rem;
      color: #a29bfe;
    }

    .manual-entry-result {
      margin-top: 20px;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      display: none;
    }

    .manual-entry-result.active {
      display: block;
    }

    .manual-entry-result.success {
      border-left: 3px solid #2ed573;
    }

    .manual-entry-result.error {
      border-left: 3px solid #ff4757;
    }

    .historical-analysis {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(39, 174, 96, 0.05));
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
    }

    .historical-analysis-title {
      color: #2ed573;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      font-size: 1rem;
      font-weight: 700;
    }

    .score-badge.high {
      background: linear-gradient(135deg, #ff4757, #c0392b);
      color: #fff;
    }

    .score-badge.medium {
      background: linear-gradient(135deg, #ffa502, #e67e22);
      color: #fff;
    }

    .score-badge.low {
      background: linear-gradient(135deg, #2ed573, #27ae60);
      color: #fff;
    }

    /* New alert indicator */
    .new-alert-indicator {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ff4757, #c0392b);
      padding: 15px 30px;
      border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(255, 71, 87, 0.5);
      cursor: pointer;
      transition: all 0.3s;
      z-index: 100;
    }

    .new-alert-indicator:hover {
      transform: translateX(-50%) scale(1.05);
    }

    .new-alert-indicator.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Pasi Alerts</h1>
      <p class="subtitle">Monitoreo de Futuros - Alertas SHORT y LONG con alto volumen</p>
    </header>

    <!-- Settings -->
    <div class="settings-panel">
      <div class="settings-row">
        <div class="setting-group">
          <label>Variacion minima (%)</label>
          <input type="number" id="minChange" value="30" min="1" max="500">
        </div>
        <div class="setting-group">
          <label>Volumen minimo (USDT)</label>
          <input type="number" id="minVolume" value="50000000" step="1000000">
        </div>
        <div class="setting-group">
          <label>Intervalo (segundos)</label>
          <input type="number" id="refreshInterval" value="30" min="10" max="300">
        </div>
        <div class="setting-group">
          <label>Tipo de senal</label>
          <select id="signalType">
            <option value="both">SHORT y LONG</option>
            <option value="short">Solo SHORT</option>
            <option value="long">Solo LONG</option>
          </select>
        </div>
        <div class="setting-group">
          <label>Incluir nuevas</label>
          <select id="includeNew">
            <option value="yes">Si (< 60 dias)</option>
            <option value="no">No</option>
            <option value="only">Solo nuevas</option>
          </select>
        </div>
        <button class="btn btn-primary" id="startBtn" onclick="toggleMonitoring()">
          Iniciar Monitoreo
        </button>
        <div class="sound-toggle">
          <label>Sonido</label>
          <div class="toggle-switch">
            <input type="checkbox" id="soundEnabled" checked>
            <span class="toggle-slider"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Alertas Activas</div>
        <div class="stat-value danger" id="alertCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mayor Subida</div>
        <div class="stat-value success" id="maxGain">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mayor Volumen</div>
        <div class="stat-value warning" id="maxVolume">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Nuevas Listadas</div>
        <div class="stat-value" id="newListingsCount" style="color: #a29bfe;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Estado</div>
        <div class="stat-value" id="statusText">Detenido</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <div class="table-header">
        <span class="table-title">Oportunidades de Trading</span>
        <span class="last-update" id="lastUpdate">Sin actualizar</span>
      </div>
      <div id="tableContent">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Presiona "Iniciar Monitoreo" para comenzar</p>
        </div>
      </div>
      <div class="data-source">
        <p>
          ðŸ“Š <strong>Fuente de datos:</strong>
          <a href="https://fapi.binance.com/fapi/v1/ticker/24hr" target="_blank">Binance Futures API - Ticker 24hr</a> |
          <a href="https://fapi.binance.com/fapi/v1/premiumIndex" target="_blank">Binance Futures API - Funding Rates</a>
        </p>
        <p class="data-source-note">Los funding rates se cobran cada 8 horas. El costo mostrado es para una posicion de $1000 USD.</p>
      </div>
    </div>
  </div>

  <!-- Bot Analyst Section -->
    <div class="bot-section">
      <div class="bot-header">
        <div class="bot-title">
          <div class="bot-icon">ðŸ¤–</div>
          <span>Bot Analista de Shorts</span>
        </div>
        <button class="clear-all-btn" onclick="clearAllSavedAlerts()">Limpiar Alertas</button>
      </div>
      <div class="bot-content">
        <!-- Tabs -->
        <div class="bot-tabs">
          <button class="bot-tab active" onclick="switchBotTab('alerts')">Alertas Guardadas</button>
          <button class="bot-tab" onclick="switchBotTab('consult')">Consultar Alerta</button>
          <button class="bot-tab" onclick="switchBotTab('database')">Base de Datos Exitosas</button>
          <button class="bot-tab" onclick="switchBotTab('import')">Importar de Binance</button>
        </div>

        <!-- Tab 1: Saved Alerts -->
        <div id="tab-alerts" class="bot-tab-content active">
          <div id="savedAlertsList" class="saved-alerts-list">
            <div class="empty-bot">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <p>Guarda alertas para que el bot las analice</p>
              <p style="font-size: 0.85rem; margin-top: 8px;">Usa el boton "Analizar" en cada alerta de la tabla</p>
            </div>
          </div>
        </div>

        <!-- Tab 2: Consult Alert -->
        <div id="tab-consult" class="bot-tab-content">
          <div class="consult-section">
            <p style="color: #aaa; margin-bottom: 20px;">
              Ingresa el simbolo de una moneda para que el bot la compare con tu base de datos de shorts exitosos y te diga si es buena candidata.
            </p>
            <div class="consult-input-row">
              <input type="text" class="consult-input" id="consultSymbol" placeholder="Ej: BTC, ETH, DOGE..." maxlength="20">
              <button class="consult-btn" id="consultBtn" onclick="consultAlert()">
                Consultar al Bot
              </button>
            </div>
            <div id="consultResult" class="consult-result"></div>
          </div>
          <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-top: 10px;">
            <p style="font-size: 0.85rem; color: #888;">
              <strong style="color: #a29bfe;">Como funciona:</strong> El bot compara los indicadores de la nueva alerta con los patrones de tus shorts exitosos.
              Mientras mas alertas exitosas cargues en la base de datos, mas preciso sera el bot.
            </p>
          </div>
        </div>

        <!-- Tab 3: Success Database -->
        <div id="tab-database" class="bot-tab-content">
          <!-- Manual Entry Form -->
          <div class="manual-entry-section">
            <div class="manual-entry-header" onclick="toggleManualEntry()">
              <span>âž• Cargar Alerta Historica Manualmente</span>
              <span class="toggle-icon" id="manualEntryToggle">â–¼</span>
            </div>
            <div class="manual-entry-form" id="manualEntryForm" style="display: none;">
              <p style="color: #888; font-size: 0.9rem; margin-bottom: 20px;">
                Ingresa los datos de un short exitoso que ya conoces. El bot analizara los indicadores de ese momento y te explicara por que fue bueno.
              </p>
              <div class="manual-form-grid">
                <div class="manual-form-group">
                  <label>Simbolo *</label>
                  <input type="text" id="manualSymbol" placeholder="Ej: DOGE, PEPE, WIF..." class="consult-input">
                </div>
                <div class="manual-form-group">
                  <label>Fecha del Short *</label>
                  <input type="date" id="manualDate" class="consult-input">
                </div>
                <div class="manual-form-group">
                  <label>Hora aproximada</label>
                  <input type="time" id="manualTime" class="consult-input" value="12:00">
                </div>
                <div class="manual-form-group">
                  <label>Cambio 24h en ese momento (%)</label>
                  <input type="number" id="manualChange" placeholder="Ej: 45" class="consult-input" step="0.1">
                </div>
                <div class="manual-form-group">
                  <label>Precio de entrada (opcional)</label>
                  <input type="number" id="manualPrice" placeholder="Ej: 0.00234" class="consult-input" step="any">
                </div>
                <div class="manual-form-group">
                  <label>Ganancia obtenida % (opcional)</label>
                  <input type="number" id="manualProfit" placeholder="Ej: 15" class="consult-input" step="0.1">
                </div>
              </div>
              <div class="manual-form-note">
                <p>ðŸ’¡ <strong>Nota:</strong> El bot buscara datos historicos de Binance para calcular RSI, volumen y otros indicadores de ese momento exacto.</p>
              </div>
              <button class="consult-btn" id="manualAddBtn" onclick="addManualEntry()" style="width: 100%; margin-top: 15px;">
                Analizar y Agregar a Base de Datos
              </button>
              <div id="manualEntryResult" class="manual-entry-result"></div>
            </div>
          </div>

          <div class="db-stats" id="dbStats">
            <div class="db-stat">
              <div class="db-stat-value" id="dbTotalCount">0</div>
              <div class="db-stat-label">Shorts Exitosos</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" id="dbAvgChange">-</div>
              <div class="db-stat-label">Cambio Promedio</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" id="dbAvgRSI">-</div>
              <div class="db-stat-label">RSI Promedio</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" id="dbAvgVolSpike">-</div>
              <div class="db-stat-label">Vol Spike Prom.</div>
            </div>
          </div>
          <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
            Esta es tu base de datos de shorts exitosos. El bot aprende de estos patrones para evaluar nuevas alertas.
          </p>

          <!-- Export/Import buttons -->
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="flex: 1; min-width: 200px;">
              <p style="color: #888; font-size: 0.8rem; margin-bottom: 8px;">ðŸ“¤ Transferir a otro dispositivo:</p>
              <button class="consult-btn" onclick="exportDatabase()" style="width: 100%; background: rgba(46, 213, 115, 0.2); color: #2ed573;">
                ðŸ“¥ Exportar Base de Datos
              </button>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <p style="color: #888; font-size: 0.8rem; margin-bottom: 8px;">ðŸ“² Importar desde archivo:</p>
              <label class="consult-btn" style="width: 100%; display: block; text-align: center; cursor: pointer; background: rgba(108, 92, 231, 0.2); color: #a29bfe;">
                ðŸ“¤ Importar Base de Datos
                <input type="file" id="importDbFile" accept=".json" onchange="importDatabase(event)" style="display: none;">
              </label>
            </div>
          </div>
          <div id="importExportStatus" style="display: none; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>

          <div id="successDbList" class="success-db-list">
            <div class="empty-bot">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <p>No hay shorts exitosos en la base de datos</p>
              <p style="font-size: 0.85rem; margin-top: 8px;">Marca alertas como "Exitosa" para que el bot aprenda</p>
            </div>
          </div>
        </div>

        <!-- Tab 4: Import from Binance -->
        <div id="tab-import" class="bot-tab-content">
          <div class="consult-section">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #F0B90B, #FCD535); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">â‚¿</div>
                <div>
                  <h3 style="color: #F0B90B; margin-bottom: 4px;">Importar Historial de Binance</h3>
                  <p style="color: #888; font-size: 0.85rem;">Conecta tu cuenta para importar shorts exitosos automaticamente</p>
                </div>
              </div>
              <button class="help-btn" onclick="showImportHelp()">
                â“ Ayuda
              </button>
            </div>

            <div style="background: rgba(240, 185, 11, 0.1); border: 1px solid rgba(240, 185, 11, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
              <p style="font-size: 0.85rem; color: #F0B90B;">
                <strong>ðŸ”’ Seguridad:</strong> Las API Keys se guardan SOLO en tu navegador (localStorage).
                Nunca se envian a ningun servidor. Usa keys con permisos de <strong>solo lectura</strong>.
              </p>
            </div>

            <div class="manual-form-grid" style="margin-bottom: 20px;">
              <div class="manual-form-group">
                <label>API Key</label>
                <input type="text" id="binanceApiKey" placeholder="Tu API Key de Binance" class="consult-input" style="text-transform: none;">
              </div>
              <div class="manual-form-group">
                <label>API Secret</label>
                <input type="password" id="binanceApiSecret" placeholder="Tu API Secret" class="consult-input" style="text-transform: none;">
              </div>
            </div>

            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
              <button class="consult-btn" onclick="saveBinanceCredentials()" style="background: linear-gradient(135deg, #F0B90B, #FCD535); color: #000;">
                ðŸ’¾ Guardar Credenciales
              </button>
              <button class="consult-btn" onclick="testBinanceConnection()" style="background: rgba(255,255,255,0.1);">
                ðŸ”Œ Probar Conexion
              </button>
              <button class="consult-btn" onclick="clearBinanceCredentials()" style="background: rgba(255, 71, 87, 0.2); color: #ff6b81;">
                ðŸ—‘ï¸ Borrar
              </button>
            </div>

            <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
              ðŸ’¡ <strong>Tip:</strong> Si tienes restriccion de IP en tu API Key, haz clic en "Probar Conexion" - el error te mostrara la IP exacta que debes agregar en Binance.
            </p>

            <div id="binanceConnectionStatus" style="padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;"></div>

            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
              <h4 style="color: #fff; margin-bottom: 15px;">Importar Trades Exitosos</h4>
              <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                Importa automaticamente tus shorts con ganancia positiva de los ultimos 90 dias.
              </p>

              <div class="manual-form-grid" style="margin-bottom: 15px;">
                <div class="manual-form-group">
                  <label>Dias a importar</label>
                  <select id="importDays" class="consult-input">
                    <option value="7">Ultimos 7 dias</option>
                    <option value="30" selected>Ultimos 30 dias</option>
                    <option value="90">Ultimos 90 dias</option>
                  </select>
                </div>
                <div class="manual-form-group">
                  <label>Ganancia minima (USD)</label>
                  <input type="number" id="minProfit" value="5" min="0" step="1" class="consult-input">
                </div>
              </div>

              <button class="consult-btn" id="importTradesBtn" onclick="importBinanceTrades()" style="width: 100%;">
                ðŸ“¥ Importar Shorts Exitosos
              </button>

              <div id="importProgress" style="margin-top: 20px; display: none;">
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 8px; overflow: hidden;">
                  <div id="importProgressBar" style="background: linear-gradient(90deg, #F0B90B, #2ed573); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <p id="importProgressText" style="color: #888; font-size: 0.85rem; margin-top: 8px; text-align: center;"></p>
              </div>

              <div id="importResult" style="margin-top: 20px; display: none;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Alert Popup -->
  <div class="alert-popup hidden" id="alertPopup">
    <button class="close-alert" onclick="closeAlert()">&times;</button>
    <h4 id="alertTitle">Nueva Alerta</h4>
    <p id="alertMessage"></p>
  </div>

  <!-- Funding Toast -->
  <div class="funding-toast" id="fundingToast">
    <div class="funding-toast-header">
      <div class="funding-toast-title" id="fundingToastTitle">
        ðŸ’° Funding Rate
      </div>
      <button class="funding-toast-close" onclick="closeFundingToast()">&times;</button>
    </div>
    <div class="funding-toast-content" id="fundingToastContent">
    </div>
  </div>

  <!-- Import Help Modal -->
  <div class="help-modal-overlay" id="importHelpModal" onclick="closeImportHelp(event)">
    <div class="help-modal" onclick="event.stopPropagation()">
      <div class="help-modal-header">
        <h2>ðŸ“š Como importar tu historial de Binance</h2>
        <button class="help-modal-close" onclick="closeImportHelp()">&times;</button>
      </div>
      <div class="help-modal-content">
        <div class="help-intro">
          <p>Esta funcion te permite importar automaticamente tus <strong>shorts exitosos</strong> de Binance Futures para que el bot aprenda de tus patrones ganadores.</p>
        </div>

        <div class="help-step">
          <div class="help-step-number">1</div>
          <div class="help-step-content">
            <h3>Ir a la pagina de API de Binance</h3>
            <p>Ingresa a tu cuenta de Binance y ve a:</p>
            <a href="https://www.binance.com/es/my/settings/api-management" target="_blank" class="help-link">
              ðŸ”— Binance > Configuracion > Gestion de API
            </a>
            <p class="help-note">O busca "API" en el menu de tu perfil.</p>
          </div>
        </div>

        <div class="help-step">
          <div class="help-step-number">2</div>
          <div class="help-step-content">
            <h3>Crear una nueva API Key</h3>
            <p>Haz clic en <strong>"Crear API"</strong> y selecciona:</p>
            <ul>
              <li>Tipo: <strong>Generada por el sistema</strong></li>
              <li>Nombre: <strong>PasiAlerts</strong> (o el que quieras)</li>
            </ul>
            <p>Completa la verificacion de seguridad (2FA, email, etc.)</p>
          </div>
        </div>

        <div class="help-step">
          <div class="help-step-number">3</div>
          <div class="help-step-content">
            <h3>Configurar permisos (MUY IMPORTANTE)</h3>
            <div class="help-warning">
              âš ï¸ <strong>Solo activa "Lectura"</strong> - NO actives trading ni retiros
            </div>
            <p>En la configuracion de la API, asegurate de:</p>
            <ul>
              <li>âœ… <strong>Habilitar lectura</strong> - Necesario para leer historial</li>
              <li>âŒ <strong>NO habilitar trading</strong> - No es necesario</li>
              <li>âŒ <strong>NO habilitar retiros</strong> - Nunca lo hagas</li>
              <li>âœ… <strong>Permitir Futuros</strong> - Para acceder a datos de futuros</li>
            </ul>
          </div>
        </div>

        <div class="help-step">
          <div class="help-step-number">4</div>
          <div class="help-step-content">
            <h3>Copiar las credenciales</h3>
            <p>Binance te mostrara dos datos:</p>
            <ul>
              <li><strong>API Key:</strong> Un codigo largo que empieza con letras</li>
              <li><strong>Secret Key:</strong> Solo se muestra UNA vez, copialo!</li>
            </ul>
            <p class="help-note">ðŸ’¡ Guarda el Secret Key en un lugar seguro, no podras verlo de nuevo.</p>
          </div>
        </div>

        <div class="help-step">
          <div class="help-step-number">5</div>
          <div class="help-step-content">
            <h3>Pegar en Pasi Alerts</h3>
            <p>Vuelve a esta app y:</p>
            <ol>
              <li>Pega la <strong>API Key</strong> en el primer campo</li>
              <li>Pega el <strong>Secret Key</strong> en el segundo campo</li>
              <li>Haz clic en <strong>"Guardar Credenciales"</strong></li>
              <li>Prueba la conexion con <strong>"Probar Conexion"</strong></li>
            </ol>
          </div>
        </div>

        <div class="help-step">
          <div class="help-step-number">6</div>
          <div class="help-step-content">
            <h3>Importar tus trades exitosos</h3>
            <p>Una vez conectado:</p>
            <ol>
              <li>Selecciona cuantos dias queres importar (7, 30 o 90)</li>
              <li>Define la ganancia minima para filtrar (ej: 1%)</li>
              <li>Haz clic en <strong>"Importar Shorts Exitosos"</strong></li>
            </ol>
            <p>El bot analizara cada trade exitoso y guardara los patrones en la base de datos.</p>
          </div>
        </div>

        <div class="help-security">
          <h3>ðŸ”’ Sobre la seguridad</h3>
          <ul>
            <li>Tus API Keys se guardan <strong>solo en tu navegador</strong> (localStorage)</li>
            <li><strong>Nunca</strong> se envian a ningun servidor externo</li>
            <li>Esta app funciona 100% en tu dispositivo</li>
            <li>Podes borrar las credenciales en cualquier momento</li>
            <li>Con permisos de solo lectura, nadie puede operar tu cuenta</li>
          </ul>
        </div>

        <div class="help-footer">
          <button class="consult-btn" onclick="closeImportHelp()" style="width: 100%;">
            Entendido, empezar a configurar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- New alerts indicator -->
  <div class="new-alert-indicator hidden" id="newAlertIndicator" onclick="scrollToTop()">
    Nuevas alertas detectadas
  </div>

  <script>
    // State
    let isMonitoring = false;
    let intervalId = null;
    let previousAlerts = new Set();
    let allCoins = [];

    // Audio context for alerts
    let audioContext = null;

    function playAlertSound() {
      if (!document.getElementById('soundEnabled').checked) return;

      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1100, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.2);

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log('Audio not available');
      }
    }

    function formatNumber(num) {
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function formatPrice(price) {
      const num = parseFloat(price);
      if (num < 0.0001) return num.toFixed(8);
      if (num < 0.01) return num.toFixed(6);
      if (num < 1) return num.toFixed(4);
      if (num < 100) return num.toFixed(3);
      return num.toFixed(2);
    }

    // Cache for active symbols and their listing dates
    let activeSymbols = new Set();
    let symbolOnboardDates = new Map(); // symbol -> onboardDate timestamp
    const TWO_MONTHS_MS = 60 * 24 * 60 * 60 * 1000; // 60 days in milliseconds

    // Funding rates cache
    let fundingRates = new Map(); // symbol -> { rate, nextFundingTime }

    // Notification permission
    let notificationPermission = 'default';

    // Binance API credentials (stored locally)
    let binanceApiKey = localStorage.getItem('binanceApiKey') || '';
    let binanceApiSecret = localStorage.getItem('binanceApiSecret') || '';

    // Request notification permission on load
    async function requestNotificationPermission() {
      if ('Notification' in window) {
        notificationPermission = await Notification.requestPermission();
        console.log('Notification permission:', notificationPermission);
      }
    }

    // Show system notification with sound
    function showSystemNotification(title, body, symbol) {
      if (notificationPermission !== 'granted') return;

      const notification = new Notification(title, {
        body: body,
        icon: './icon-192.png',
        badge: './icon-192.png',
        vibrate: [200, 100, 200],
        tag: symbol,
        requireInteraction: true
      });

      notification.onclick = () => {
        window.focus();
        openBinance(symbol + 'USDT');
        notification.close();
      };

      // Play sound with notification
      playAlertSound();
    }

    // Fetch funding rates from Binance
    async function fetchFundingRates() {
      try {
        const response = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
        if (!response.ok) throw new Error('Funding Rate API Error');

        const data = await response.json();
        fundingRates.clear();

        data.forEach(item => {
          fundingRates.set(item.symbol, {
            rate: parseFloat(item.lastFundingRate) * 100, // Convert to percentage
            nextFundingTime: item.nextFundingTime,
            markPrice: parseFloat(item.markPrice)
          });
        });

        console.log(`Loaded funding rates for ${fundingRates.size} symbols`);
        return true;
      } catch (error) {
        console.error('Error fetching funding rates:', error);
        return false;
      }
    }

    // Calculate funding cost for holding position
    function calculateFundingCost(symbol, positionSize, hours) {
      const funding = fundingRates.get(symbol);
      if (!funding) return null;

      // Funding is charged every 8 hours
      const fundingPeriods = hours / 8;
      const costPerPeriod = positionSize * (funding.rate / 100);
      return costPerPeriod * fundingPeriods;
    }

    // Format time until next funding
    function formatTimeUntilFunding(nextFundingTime) {
      const now = Date.now();
      const diff = nextFundingTime - now;
      if (diff <= 0) return 'Ahora';

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${minutes}m`;
    }

    // Show funding rate explanation toast
    function showFundingToast(symbol, fundingRate, cost24h, signalType, nextFundingTime) {
      const toast = document.getElementById('fundingToast');
      const title = document.getElementById('fundingToastTitle');
      const content = document.getElementById('fundingToastContent');

      const isShort = signalType === 'SHORT';
      const isPositiveFunding = fundingRate > 0;

      // Determine if this is good or bad for the user's position
      const isGoodForUser = (isShort && isPositiveFunding) || (!isShort && !isPositiveFunding);

      const emoji = isGoodForUser ? 'ðŸ’°' : 'ðŸ’¸';
      const resultText = isGoodForUser ? 'TE PAGAN' : 'VOS PAGAS';
      const resultClass = isGoodForUser ? 'good' : 'bad';

      title.innerHTML = `${emoji} Funding Rate - ${symbol}`;

      const timeUntilFunding = nextFundingTime ? formatTimeUntilFunding(nextFundingTime) : 'N/A';

      content.innerHTML = `
        <div class="funding-info-row">
          <span class="funding-info-label">Funding Rate actual:</span>
          <span class="funding-info-value ${fundingRate > 0 ? 'highlight' : 'good'}">${fundingRate.toFixed(4)}%</span>
        </div>
        <div class="funding-info-row">
          <span class="funding-info-label">Se cobra cada:</span>
          <span class="funding-info-value">8 horas</span>
        </div>
        <div class="funding-info-row">
          <span class="funding-info-label">Proximo cobro en:</span>
          <span class="funding-info-value">${timeUntilFunding}</span>
        </div>
        <div class="funding-info-row">
          <span class="funding-info-label">Costo/Ganancia por $1000 en 24hs:</span>
          <span class="funding-info-value ${resultClass}">$${cost24h.toFixed(2)}</span>
        </div>

        <div class="funding-summary ${isGoodForUser ? 'good-summary' : 'bad-summary'}">
          <strong>Para tu posicion ${signalType}:</strong><br><br>
          ${isPositiveFunding ?
            `El funding es <span class="highlight">positivo (${fundingRate.toFixed(4)}%)</span>, lo que significa que los <strong>LONG pagan a los SHORT</strong>.` :
            `El funding es <span class="good">negativo (${fundingRate.toFixed(4)}%)</span>, lo que significa que los <strong>SHORT pagan a los LONG</strong>.`
          }
          <br><br>
          ${isGoodForUser ?
            `<span class="good">âœ… ${resultText}</span> - Ademas de tu ganancia por el movimiento del precio, recibis <strong>$${cost24h.toFixed(2)}</strong> cada 24hs por cada $1000.` :
            `<span class="bad">âŒ ${resultText}</span> - Tenes que pagar <strong>$${cost24h.toFixed(2)}</strong> cada 24hs por cada $1000. El precio tiene que moverse a tu favor para compensar este costo.`
          }
        </div>

        <p style="margin-top: 15px; font-size: 0.8rem; color: #888;">
          ðŸ’¡ <strong>Tip:</strong> Si el funding es muy alto (>0.5%), considera cerrar la posicion antes del proximo cobro o asegurate de que tu ganancia compense el costo.
        </p>
      `;

      toast.classList.add('show');
    }

    // Close funding toast
    function closeFundingToast() {
      document.getElementById('fundingToast').classList.remove('show');
    }

    // Close toast when clicking outside
    document.addEventListener('click', function(e) {
      const toast = document.getElementById('fundingToast');
      if (toast && toast.classList.contains('show')) {
        if (!toast.contains(e.target) && !e.target.classList.contains('funding-cell')) {
          closeFundingToast();
        }
      }
    });

    // Show import help modal
    function showImportHelp() {
      document.getElementById('importHelpModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    // Close import help modal
    function closeImportHelp(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('importHelpModal').classList.remove('show');
      document.body.style.overflow = '';
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeImportHelp();
        closeFundingToast();
      }
    });

    // Calculate quick score without API calls (uses available data)
    function calculateQuickScore(coin) {
      const change = parseFloat(coin.priceChangePercent);
      const absChange = Math.abs(change);
      const price = parseFloat(coin.lastPrice);
      const high = parseFloat(coin.highPrice);
      const low = parseFloat(coin.lowPrice);
      const volume = parseFloat(coin.quoteVolume);
      const isNew = isNewlyListed(coin.symbol);
      const isShort = change > 0;

      let score = 0;
      let factors = [];

      // 1. Price change score (max 30)
      if (absChange >= 100) {
        score += 30;
        factors.push('Pump/Dump extremo');
      } else if (absChange >= 50) {
        score += 25;
        factors.push('Movimiento muy fuerte');
      } else if (absChange >= 30) {
        score += 15;
        factors.push('Movimiento fuerte');
      } else if (absChange >= 20) {
        score += 10;
        factors.push('Movimiento moderado');
      }

      // 2. Distance from extreme (max 20)
      const distanceFromHigh = ((high - price) / high) * 100;
      const distanceFromLow = ((price - low) / low) * 100;

      if (isShort && distanceFromHigh < 2) {
        score += 20;
        factors.push('Cerca del maximo');
      } else if (isShort && distanceFromHigh < 5) {
        score += 10;
        factors.push('Zona alta');
      } else if (!isShort && distanceFromLow < 2) {
        score += 20;
        factors.push('Cerca del minimo');
      } else if (!isShort && distanceFromLow < 5) {
        score += 10;
        factors.push('Zona baja');
      }

      // 3. Range/Volatility score (max 15)
      const range24h = ((high - low) / low) * 100;
      if (range24h > 80) {
        score += 15;
        factors.push('Volatilidad extrema');
      } else if (range24h > 50) {
        score += 10;
        factors.push('Alta volatilidad');
      } else if (range24h > 30) {
        score += 5;
        factors.push('Volatilidad moderada');
      }

      // 4. New listing bonus (max 15)
      if (isNew) {
        const days = getDaysListed(coin.symbol);
        if (days <= 7) {
          score += 15;
          factors.push('Muy nuevo (<7d)');
        } else if (days <= 30) {
          score += 10;
          factors.push('Nuevo (<30d)');
        } else {
          score += 5;
          factors.push('Reciente (<60d)');
        }
      }

      // 5. Volume score (max 10) - high volume = more reliable signal
      if (volume > 500000000) {
        score += 10;
        factors.push('Volumen muy alto');
      } else if (volume > 100000000) {
        score += 5;
        factors.push('Buen volumen');
      }

      // 6. Funding rate bonus (max 10)
      const funding = fundingRates.get(coin.symbol);
      if (funding) {
        const fundingRate = Math.abs(funding.rate);
        if (fundingRate > 0.5) {
          score += 10;
          factors.push('Funding extremo');
        } else if (fundingRate > 0.1) {
          score += 5;
          factors.push('Funding alto');
        }
      }

      return {
        score: Math.min(score, 100),
        factors: factors
      };
    }

    async function fetchActiveSymbols() {
      try {
        // Get exchange info to know which symbols are actively trading
        const response = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
        if (!response.ok) throw new Error('Exchange Info API Error');

        const data = await response.json();

        // Filter only symbols that are TRADING status and are PERPETUAL contracts
        const tradingSymbols = data.symbols.filter(
          s => s.status === 'TRADING' && s.contractType === 'PERPETUAL'
        );

        activeSymbols = new Set(tradingSymbols.map(s => s.symbol));

        // Store onboard dates for each symbol
        tradingSymbols.forEach(s => {
          if (s.onboardDate) {
            symbolOnboardDates.set(s.symbol, s.onboardDate);
          }
        });

        console.log(`Loaded ${activeSymbols.size} active perpetual futures symbols`);
        return true;
      } catch (error) {
        console.error('Error fetching exchange info:', error);
        return false;
      }
    }

    function isNewlyListed(symbol) {
      const onboardDate = symbolOnboardDates.get(symbol);
      if (!onboardDate) return false;

      const now = Date.now();
      const age = now - onboardDate;
      return age <= TWO_MONTHS_MS;
    }

    function getDaysListed(symbol) {
      const onboardDate = symbolOnboardDates.get(symbol);
      if (!onboardDate) return null;

      const now = Date.now();
      const age = now - onboardDate;
      return Math.floor(age / (24 * 60 * 60 * 1000));
    }

    async function fetchFuturesData() {
      try {
        // If we don't have active symbols yet, fetch them first
        if (activeSymbols.size === 0) {
          await fetchActiveSymbols();
        }

        // Fetch funding rates in parallel with ticker data
        const [tickerResponse] = await Promise.all([
          fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
          fetchFundingRates()
        ]);

        if (!tickerResponse.ok) throw new Error('API Error');

        const data = await tickerResponse.json();

        // Filter only actively trading symbols
        const filteredData = data.filter(coin => activeSymbols.has(coin.symbol));

        return filteredData;
      } catch (error) {
        console.error('Error fetching data:', error);
        return null;
      }
    }

    function filterAndSortCoins(data) {
      const minChange = parseFloat(document.getElementById('minChange').value);
      const minVolume = parseFloat(document.getElementById('minVolume').value);
      const includeNew = document.getElementById('includeNew').value;
      const signalType = document.getElementById('signalType').value;

      // Filter USDT pairs
      let filtered = data.filter(coin => {
        const symbol = coin.symbol;
        const priceChangePercent = parseFloat(coin.priceChangePercent);
        const absChange = Math.abs(priceChangePercent);
        const quoteVolume = parseFloat(coin.quoteVolume);
        const isNew = isNewlyListed(symbol);

        // Must be USDT pair
        if (!symbol.endsWith('USDT')) return false;

        // Check signal type filter
        const isShortSignal = priceChangePercent >= minChange; // Price went UP = SHORT opportunity
        const isLongSignal = priceChangePercent <= -minChange; // Price went DOWN = LONG opportunity

        let matchesSignalType = false;
        if (signalType === 'both') {
          matchesSignalType = isShortSignal || isLongSignal;
        } else if (signalType === 'short') {
          matchesSignalType = isShortSignal;
        } else if (signalType === 'long') {
          matchesSignalType = isLongSignal;
        }

        if (!matchesSignalType) return false;

        // Handle different modes for new listings
        if (includeNew === 'only') {
          return isNew && absChange >= minChange && quoteVolume >= minVolume;
        } else if (includeNew === 'yes') {
          const meetsMainCriteria = quoteVolume >= minVolume;
          const isNewWithMovement = isNew && absChange >= 10 && quoteVolume >= 10000000;
          return meetsMainCriteria || isNewWithMovement;
        } else {
          return quoteVolume >= minVolume;
        }
      });

      // Sort by absolute change percentage descending (biggest movers first)
      filtered.sort((a, b) => Math.abs(parseFloat(b.priceChangePercent)) - Math.abs(parseFloat(a.priceChangePercent)));

      return filtered;
    }

    function renderTable(coins) {
      const container = document.getElementById('tableContent');

      if (coins.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <p>No hay criptomonedas que cumplan los criterios actuales</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th onclick="sortTable('symbol')">Simbolo</th>
              <th onclick="sortTable('score')">Score</th>
              <th onclick="sortTable('signal')">Senal</th>
              <th onclick="sortTable('price')">Precio</th>
              <th onclick="sortTable('change')" class="sorted">Cambio 24h</th>
              <th onclick="sortTable('funding')">Funding</th>
              <th onclick="sortTable('fundingCost')">Costo 24h</th>
              <th onclick="sortTable('volume')">Volumen</th>
              <th>Accion</th>
            </tr>
          </thead>
          <tbody>
      `;

      coins.forEach(coin => {
        const symbol = coin.symbol.replace('USDT', '');
        const price = formatPrice(coin.lastPrice);
        const changeNum = parseFloat(coin.priceChangePercent);
        const change = changeNum.toFixed(2);
        const absChange = Math.abs(changeNum);
        const volume = formatNumber(parseFloat(coin.quoteVolume));

        // Calculate quick score
        const scoreData = calculateQuickScore(coin);
        const score = scoreData.score;
        const scoreClass = score >= 70 ? 'score-high' : score >= 50 ? 'score-medium' : score >= 30 ? 'score-low' : 'score-minimal';
        const scoreFactors = scoreData.factors.join(' | ');

        // Determine signal type
        const isShort = changeNum > 0;
        const signalType = isShort ? 'SHORT' : 'LONG';
        const signalClass = isShort ? 'signal-short' : 'signal-long';
        const signalIcon = isShort ? 'ðŸ“‰' : 'ðŸ“ˆ';

        // Get funding rate info
        const funding = fundingRates.get(coin.symbol);
        const fundingRate = funding ? funding.rate.toFixed(4) : 'N/A';
        const fundingRateNum = funding ? funding.rate : 0;

        // Calculate cost for $1000 position held 24 hours (3 funding periods)
        const cost24h = funding ? (1000 * Math.abs(funding.rate / 100) * 3).toFixed(2) : 'N/A';

        // Funding rate color depends on signal type:
        // SHORT signal + positive funding = GOOD (green) - te pagan
        // SHORT signal + negative funding = BAD (red) - vos pagas
        // LONG signal + positive funding = BAD (red) - vos pagas
        // LONG signal + negative funding = GOOD (green) - te pagan
        let fundingClass = '';
        let fundingIcon = '';
        if (Math.abs(fundingRateNum) > 0.01) {
          if (isShort) {
            // Para SHORT: funding positivo es bueno (te pagan)
            fundingClass = fundingRateNum > 0 ? 'funding-good' : 'funding-bad';
            fundingIcon = fundingRateNum > 0 ? ' ðŸ’°' : ' ðŸ’¸';
          } else {
            // Para LONG: funding negativo es bueno (te pagan)
            fundingClass = fundingRateNum < 0 ? 'funding-good' : 'funding-bad';
            fundingIcon = fundingRateNum < 0 ? ' ðŸ’°' : ' ðŸ’¸';
          }
        }
        const fundingWarning = Math.abs(fundingRateNum) > 0.5 ? ' âš ï¸' : '';

        // Risk level based on absolute change
        const riskLevel = absChange >= 50 ? 'high' : absChange >= 30 ? 'medium' : 'low';
        const riskText = absChange >= 50 ? 'ALTO' : absChange >= 30 ? 'MEDIO' : 'BAJO';

        const isNew = isNewlyListed(coin.symbol);
        const daysListed = getDaysListed(coin.symbol);
        const newBadge = isNew ? `<span class="new-badge">NUEVO</span>` : '';
        const daysText = isNew && daysListed !== null ? `<div class="days-listed">${daysListed} dias en Binance</div>` : '';

        // Change color based on direction
        const changeClass = isShort ? 'change-positive' : 'change-negative';
        const changePrefix = isShort ? '+' : '';

        html += `
          <tr>
            <td>
              <div class="symbol">
                <div class="symbol-icon" style="background: ${isShort ? 'linear-gradient(135deg, #ff4757, #ff6b81)' : 'linear-gradient(135deg, #2ed573, #7bed9f)'}">${symbol.substring(0, 2)}</div>
                <div>
                  <div>${symbol}/USDT ${newBadge}</div>
                  ${daysText}
                </div>
              </div>
            </td>
            <td class="score-cell" title="${scoreFactors}">
              <div class="score-badge-table ${scoreClass}">${score}</div>
            </td>
            <td><span class="signal-badge ${signalClass}">${signalIcon} ${signalType}</span></td>
            <td class="price">$${price}</td>
            <td class="${changeClass}">${changePrefix}${change}%</td>
            <td class="${fundingClass} funding-cell" onclick="showFundingToast('${symbol}', ${fundingRateNum}, ${cost24h !== 'N/A' ? cost24h : 0}, '${signalType}', ${funding ? funding.nextFundingTime : 0})">${fundingRate}%${fundingIcon}${fundingWarning}</td>
            <td class="${fundingClass}" onclick="showFundingToast('${symbol}', ${fundingRateNum}, ${cost24h !== 'N/A' ? cost24h : 0}, '${signalType}', ${funding ? funding.nextFundingTime : 0})">$${cost24h}</td>
            <td class="volume">${volume}</td>
            <td style="display:flex;gap:8px;">
              <button class="save-alert-btn" onclick="saveAlertForAnalysis('${coin.symbol}')">
                Analizar
              </button>
              <button class="action-btn" onclick="openBinance('${coin.symbol}')">
                Binance
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function updateStats(coins) {
      document.getElementById('alertCount').textContent = coins.length;

      // Count newly listed coins
      const newListings = coins.filter(c => isNewlyListed(c.symbol)).length;
      document.getElementById('newListingsCount').textContent = newListings;

      if (coins.length > 0) {
        const maxGain = Math.max(...coins.map(c => parseFloat(c.priceChangePercent)));
        document.getElementById('maxGain').textContent = '+' + maxGain.toFixed(2) + '%';

        const maxVol = Math.max(...coins.map(c => parseFloat(c.quoteVolume)));
        document.getElementById('maxVolume').textContent = formatNumber(maxVol);
      } else {
        document.getElementById('maxGain').textContent = '-';
        document.getElementById('maxVolume').textContent = '-';
      }
    }

    function checkNewAlerts(coins) {
      const currentSymbols = new Set(coins.map(c => c.symbol));
      let newAlerts = [];

      currentSymbols.forEach(symbol => {
        if (!previousAlerts.has(symbol)) {
          const coin = coins.find(c => c.symbol === symbol);
          if (coin) {
            newAlerts.push(coin);
          }
        }
      });

      if (newAlerts.length > 0 && previousAlerts.size > 0) {
        // Show in-app popup
        showAlertPopup(newAlerts[0]);

        // Send system notification for each new alert (with sound)
        newAlerts.forEach(coin => {
          const symbol = coin.symbol.replace('USDT', '');
          const changeNum = parseFloat(coin.priceChangePercent);
          const change = changeNum.toFixed(2);
          const isShort = changeNum > 0;
          const signalType = isShort ? 'SHORT' : 'LONG';
          const signalEmoji = isShort ? 'ðŸ“‰' : 'ðŸ“ˆ';
          const funding = fundingRates.get(coin.symbol);
          const fundingInfo = funding ? ` | Funding: ${funding.rate.toFixed(3)}%` : '';

          showSystemNotification(
            `${signalEmoji} ${signalType}: ${symbol}`,
            `${isShort ? '+' : ''}${change}% en 24h | Vol: ${formatNumber(parseFloat(coin.quoteVolume))}${fundingInfo}`,
            symbol
          );
        });
      }

      previousAlerts = currentSymbols;
    }

    function showAlertPopup(coin) {
      const popup = document.getElementById('alertPopup');
      const symbol = coin.symbol.replace('USDT', '');
      const changeNum = parseFloat(coin.priceChangePercent);
      const change = changeNum.toFixed(2);
      const isShort = changeNum > 0;
      const signalType = isShort ? 'SHORT' : 'LONG';
      const signalEmoji = isShort ? 'ðŸ“‰' : 'ðŸ“ˆ';
      const action = isShort ? 'subio' : 'bajo';

      document.getElementById('alertTitle').textContent = `${signalEmoji} ${signalType}: ${symbol}`;
      document.getElementById('alertMessage').textContent =
        `${symbol}/USDT ${action} ${isShort ? '+' : ''}${change}% en 24h. Volumen: ${formatNumber(parseFloat(coin.quoteVolume))} USDT`;

      popup.classList.remove('hidden');

      setTimeout(() => {
        popup.classList.add('hidden');
      }, 8000);
    }

    function closeAlert() {
      document.getElementById('alertPopup').classList.add('hidden');
    }

    async function updateData() {
      const data = await fetchFuturesData();

      if (!data) {
        document.getElementById('statusText').textContent = 'Error';
        return;
      }

      allCoins = filterAndSortCoins(data);
      renderTable(allCoins);
      updateStats(allCoins);
      checkNewAlerts(allCoins);

      const now = new Date();
      document.getElementById('lastUpdate').textContent =
        `Ultima actualizacion: ${now.toLocaleTimeString()}`;
    }

    function toggleMonitoring() {
      const btn = document.getElementById('startBtn');
      const status = document.getElementById('statusText');

      if (isMonitoring) {
        // Stop
        clearInterval(intervalId);
        isMonitoring = false;
        btn.textContent = 'Iniciar Monitoreo';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        status.textContent = 'Detenido';
        status.style.color = '#888';
      } else {
        // Start
        const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
        isMonitoring = true;
        btn.textContent = 'Detener Monitoreo';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        status.textContent = 'Activo';
        status.style.color = '#2ed573';

        // Initial fetch
        updateData();

        // Set interval
        intervalId = setInterval(updateData, interval);
      }
    }

    function openBinance(symbol) {
      window.open(`https://www.binance.com/es/futures/${symbol}`, '_blank');
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      document.getElementById('newAlertIndicator').classList.add('hidden');
    }

    // Sort functionality
    let currentSort = { column: 'change', ascending: false };

    function sortTable(column) {
      if (!allCoins.length) return;

      const ascending = currentSort.column === column ? !currentSort.ascending : false;
      currentSort = { column, ascending };

      allCoins.sort((a, b) => {
        let valA, valB;

        switch(column) {
          case 'symbol':
            valA = a.symbol;
            valB = b.symbol;
            return ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
          case 'price':
            valA = parseFloat(a.lastPrice);
            valB = parseFloat(b.lastPrice);
            break;
          case 'change':
            valA = parseFloat(a.priceChangePercent);
            valB = parseFloat(b.priceChangePercent);
            break;
          case 'high':
            valA = parseFloat(a.highPrice);
            valB = parseFloat(b.highPrice);
            break;
          case 'low':
            valA = parseFloat(a.lowPrice);
            valB = parseFloat(b.lowPrice);
            break;
          case 'volume':
            valA = parseFloat(a.quoteVolume);
            valB = parseFloat(b.quoteVolume);
            break;
          default:
            return 0;
        }

        return ascending ? valA - valB : valB - valA;
      });

      renderTable(allCoins);
    }

    // Format volume input with thousand separators
    document.getElementById('minVolume').addEventListener('blur', function() {
      const val = parseInt(this.value) || 50000000;
      this.value = val;
    });

    // ==================== BOT ANALYST SYSTEM ====================

    // Saved alerts storage (session only - not persisted)
    let savedAlerts = [];

    // Success database storage (must be initialized before renderSavedAlerts)
    let successDatabase = JSON.parse(localStorage.getItem('successShortDatabase') || '[]');

    // Check if alert is in success database
    function isInSuccessDb(symbol, savedAt) {
      return successDatabase.some(s => s.symbol === symbol && s.savedAt === savedAt);
    }

    // Calculate bot similarity score based on success database patterns
    function calculateBotSimilarityScore(coin, analysis) {
      // If no success database, return N/A
      if (!successDatabase || successDatabase.length === 0) {
        return { score: null, message: 'Sin datos de referencia' };
      }

      const change = parseFloat(coin.priceChangePercent) || 0;
      const rsi = analysis && typeof analysis.rsi === 'number' ? analysis.rsi : null;
      const volSpike = analysis && typeof analysis.volumeSpike === 'number' ? analysis.volumeSpike : null;
      const distFromHigh = analysis && typeof analysis.distanceFromHigh === 'number' ? analysis.distanceFromHigh : null;

      // Calculate average patterns from success database (with safe access)
      const validChangeEntries = successDatabase.filter(s => typeof s.change24h === 'number' && !isNaN(s.change24h));
      const avgChange = validChangeEntries.length > 0
        ? validChangeEntries.reduce((sum, s) => sum + Math.abs(s.change24h), 0) / validChangeEntries.length
        : 0;

      const rsiAlerts = successDatabase.filter(s => s.analysis && typeof s.analysis.rsi === 'number' && !isNaN(s.analysis.rsi));
      const avgRSI = rsiAlerts.length > 0
        ? rsiAlerts.reduce((sum, s) => sum + s.analysis.rsi, 0) / rsiAlerts.length
        : null;

      const volSpikeAlerts = successDatabase.filter(s => s.analysis && typeof s.analysis.volumeSpike === 'number' && !isNaN(s.analysis.volumeSpike));
      const avgVolSpike = volSpikeAlerts.length > 0
        ? volSpikeAlerts.reduce((sum, s) => sum + s.analysis.volumeSpike, 0) / volSpikeAlerts.length
        : null;

      const distAlerts = successDatabase.filter(s => s.analysis && typeof s.analysis.distanceFromHigh === 'number' && !isNaN(s.analysis.distanceFromHigh));
      const avgDistFromHigh = distAlerts.length > 0
        ? distAlerts.reduce((sum, s) => sum + s.analysis.distanceFromHigh, 0) / distAlerts.length
        : null;

      // Calculate similarity scores for each indicator
      let totalSimilarity = 0;
      let factorCount = 0;

      // Change similarity (weight: 30%)
      if (avgChange > 0 && !isNaN(change)) {
        const changeDeviation = Math.abs(Math.abs(change) - avgChange) / avgChange;
        const changeSimilarity = Math.max(0, Math.min(100, 100 - changeDeviation * 50));
        if (!isNaN(changeSimilarity)) {
          totalSimilarity += changeSimilarity * 0.3;
          factorCount += 0.3;
        }
      }

      // RSI similarity (weight: 25%)
      if (rsi !== null && avgRSI !== null && avgRSI > 0) {
        const rsiDeviation = Math.abs(rsi - avgRSI) / avgRSI;
        const rsiSimilarity = Math.max(0, Math.min(100, 100 - rsiDeviation * 100));
        if (!isNaN(rsiSimilarity)) {
          totalSimilarity += rsiSimilarity * 0.25;
          factorCount += 0.25;
        }
      }

      // Volume spike similarity (weight: 20%)
      if (volSpike !== null && avgVolSpike !== null && avgVolSpike > 0) {
        const volDeviation = Math.abs(volSpike - avgVolSpike) / avgVolSpike;
        const volSimilarity = Math.max(0, Math.min(100, 100 - volDeviation * 50));
        if (!isNaN(volSimilarity)) {
          totalSimilarity += volSimilarity * 0.2;
          factorCount += 0.2;
        }
      }

      // Distance from high similarity (weight: 25%)
      if (distFromHigh !== null && avgDistFromHigh !== null && avgDistFromHigh > 0) {
        const distDeviation = Math.abs(distFromHigh - avgDistFromHigh) / avgDistFromHigh;
        const distSimilarity = Math.max(0, Math.min(100, 100 - distDeviation * 100));
        if (!isNaN(distSimilarity)) {
          totalSimilarity += distSimilarity * 0.25;
          factorCount += 0.25;
        }
      }

      // Calculate final score
      let overallScore = null;
      if (factorCount > 0) {
        overallScore = Math.round(totalSimilarity / factorCount);
        if (isNaN(overallScore)) overallScore = null;
      }

      // Generate recommendation message
      let message = 'Sin datos suficientes';
      if (overallScore !== null) {
        if (overallScore >= 80) {
          message = 'Muy similar a tus exitosos';
        } else if (overallScore >= 60) {
          message = 'Patron similar';
        } else if (overallScore >= 40) {
          message = 'Similitud moderada';
        } else {
          message = 'Patron diferente';
        }
      }

      return {
        score: overallScore,
        message: message,
        avgPatterns: { change: avgChange, rsi: avgRSI, volSpike: avgVolSpike, distFromHigh: avgDistFromHigh }
      };
    }

    // Save alert for analysis
    async function saveAlertForAnalysis(symbol) {
      // Find coin data
      const coin = allCoins.find(c => c.symbol === symbol);
      if (!coin) {
        alert('No se encontraron datos de la moneda');
        return;
      }

      // Fetch additional data for analysis
      const klineData = await fetchKlineData(symbol);
      const analysis = await analyzeForShort(coin, klineData);

      // Calculate quick score (same as monitoring table)
      const quickScoreData = calculateQuickScore(coin);

      // Calculate bot similarity score based on success database
      const botScore = calculateBotSimilarityScore(coin, analysis);

      const savedAlert = {
        symbol: coin.symbol,
        savedAt: Date.now(),
        price: parseFloat(coin.lastPrice),
        change24h: parseFloat(coin.priceChangePercent),
        high24h: parseFloat(coin.highPrice),
        low24h: parseFloat(coin.lowPrice),
        volume: parseFloat(coin.quoteVolume),
        isNew: isNewlyListed(coin.symbol),
        daysListed: getDaysListed(coin.symbol),
        analysis: analysis,
        quickScore: quickScoreData.score,
        botScore: botScore
      };

      // Remove existing alert for this symbol (replace with new analysis)
      const existingIndex = savedAlerts.findIndex(a => a.symbol === symbol);
      if (existingIndex !== -1) {
        savedAlerts.splice(existingIndex, 1);
      }

      savedAlerts.unshift(savedAlert);
      renderSavedAlerts();

      // Scroll to bot section
      document.querySelector('.bot-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Fetch kline data for technical analysis
    async function fetchKlineData(symbol) {
      try {
        // Get 1h klines for RSI and trend analysis
        const response = await fetch(
          `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=50`
        );
        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        console.error('Error fetching klines:', error);
        return null;
      }
    }

    // Calculate RSI from kline data
    function calculateRSI(klines, period = 14) {
      if (!klines || klines.length < period + 1) return null;

      const closes = klines.map(k => parseFloat(k[4]));
      let gains = 0;
      let losses = 0;

      for (let i = 1; i <= period; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) gains += change;
        else losses += Math.abs(change);
      }

      let avgGain = gains / period;
      let avgLoss = losses / period;

      for (let i = period + 1; i < closes.length; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) + Math.abs(change)) / period;
        }
      }

      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    // Calculate price distance from high
    function calculateDistanceFromHigh(price, high24h) {
      return ((high24h - price) / high24h) * 100;
    }

    // Calculate volume spike
    function calculateVolumeSpike(klines) {
      if (!klines || klines.length < 20) return null;

      const volumes = klines.map(k => parseFloat(k[5]));
      const recentVol = volumes.slice(-4).reduce((a, b) => a + b, 0) / 4;
      const avgVol = volumes.slice(0, -4).reduce((a, b) => a + b, 0) / (volumes.length - 4);

      return recentVol / avgVol;
    }

    // Analyze coin for short opportunity
    async function analyzeForShort(coin, klineData) {
      const change = parseFloat(coin.priceChangePercent);
      const price = parseFloat(coin.lastPrice);
      const high = parseFloat(coin.highPrice);
      const low = parseFloat(coin.lowPrice);
      const volume = parseFloat(coin.quoteVolume);
      const isNew = isNewlyListed(coin.symbol);
      const days = getDaysListed(coin.symbol);

      // Calculate indicators
      const rsi = calculateRSI(klineData);
      const distanceFromHigh = calculateDistanceFromHigh(price, high);
      const volumeSpike = calculateVolumeSpike(klineData);

      // Build analysis
      const indicators = [];
      const reasons = [];
      let shortScore = 0;

      // 1. Analyze price change (overextension)
      if (change >= 100) {
        shortScore += 30;
        indicators.push({ name: 'Pump Extremo', type: 'bearish' });
        reasons.push(`El precio subio <strong>+${change.toFixed(1)}%</strong> en 24h, lo cual representa un pump extremo. Historicamente, subidas mayores al 100% tienden a corregir fuertemente.`);
      } else if (change >= 50) {
        shortScore += 25;
        indicators.push({ name: 'Sobreextension Alta', type: 'bearish' });
        reasons.push(`Una subida del <strong>+${change.toFixed(1)}%</strong> indica sobreextension significativa. El activo esta propenso a toma de ganancias.`);
      } else if (change >= 30) {
        shortScore += 15;
        indicators.push({ name: 'Rally Fuerte', type: 'neutral' });
        reasons.push(`El rally del <strong>+${change.toFixed(1)}%</strong> sugiere momentum alcista que podria estar agotandose.`);
      }

      // 2. Analyze RSI
      if (rsi !== null) {
        if (rsi >= 80) {
          shortScore += 25;
          indicators.push({ name: `RSI ${rsi.toFixed(0)}`, type: 'bearish' });
          reasons.push(`El RSI en <strong>${rsi.toFixed(1)}</strong> indica condicion de sobrecompra extrema. Zona tipica de reversion bajista.`);
        } else if (rsi >= 70) {
          shortScore += 15;
          indicators.push({ name: `RSI ${rsi.toFixed(0)}`, type: 'bearish' });
          reasons.push(`RSI en <strong>${rsi.toFixed(1)}</strong> - territorio de sobrecompra. Aumenta probabilidad de correccion.`);
        } else if (rsi >= 60) {
          shortScore += 5;
          indicators.push({ name: `RSI ${rsi.toFixed(0)}`, type: 'neutral' });
          reasons.push(`RSI en <strong>${rsi.toFixed(1)}</strong> - momentum alcista pero sin sobrecompra extrema.`);
        }
      }

      // 3. Analyze distance from high
      if (distanceFromHigh < 2) {
        shortScore += 20;
        indicators.push({ name: 'Cerca del Maximo', type: 'bearish' });
        reasons.push(`El precio esta a solo <strong>${distanceFromHigh.toFixed(1)}%</strong> del maximo de 24h. Zona de resistencia y posible rechazo.`);
      } else if (distanceFromHigh < 5) {
        shortScore += 10;
        indicators.push({ name: 'Zona Alta', type: 'neutral' });
        reasons.push(`Precio a <strong>${distanceFromHigh.toFixed(1)}%</strong> del maximo. Todavia en zona elevada.`);
      }

      // 4. Analyze volume
      if (volumeSpike !== null && volumeSpike > 3) {
        shortScore += 15;
        indicators.push({ name: 'Volumen Extremo', type: 'bearish' });
        reasons.push(`Volumen <strong>${volumeSpike.toFixed(1)}x</strong> mayor al promedio. Alto volumen en maximos suele indicar climax de compra (distribucion).`);
      } else if (volumeSpike !== null && volumeSpike > 2) {
        shortScore += 10;
        indicators.push({ name: 'Volumen Alto', type: 'neutral' });
        reasons.push(`Volumen <strong>${volumeSpike.toFixed(1)}x</strong> sobre el promedio indica interes elevado.`);
      }

      // 5. New listing analysis
      if (isNew) {
        shortScore += 15;
        indicators.push({ name: `Nuevo (${days}d)`, type: 'info' });
        reasons.push(`<span class="warning">Listado hace solo ${days} dias.</span> Las monedas nuevas tienen alta volatilidad y los pumps iniciales suelen revertir cuando termina el hype.`);
      }

      // 6. Range analysis
      const range24h = ((high - low) / low) * 100;
      if (range24h > 50) {
        shortScore += 10;
        indicators.push({ name: 'Alta Volatilidad', type: 'bearish' });
        reasons.push(`Rango del <strong>${range24h.toFixed(1)}%</strong> en 24h indica volatilidad extrema. Mayor riesgo pero tambien mayor potencial de correccion.`);
      }

      // Calculate final score (max 100)
      shortScore = Math.min(shortScore, 100);

      // Generate summary
      let summary = '';
      if (shortScore >= 70) {
        summary = `<strong>ALTA PROBABILIDAD DE SHORT</strong> - Multiples indicadores confluyen para una posible correccion. Score: ${shortScore}/100`;
      } else if (shortScore >= 50) {
        summary = `<strong>PROBABILIDAD MODERADA</strong> - Hay senales bajistas pero no son extremas. Esperar confirmacion. Score: ${shortScore}/100`;
      } else {
        summary = `<strong>PROBABILIDAD BAJA</strong> - Pocas senales de reversion inmediata. Monitorear. Score: ${shortScore}/100`;
      }

      return {
        score: shortScore,
        rsi: rsi,
        distanceFromHigh: distanceFromHigh,
        volumeSpike: volumeSpike,
        indicators: indicators,
        reasons: reasons,
        summary: summary
      };
    }

    // Render saved alerts
    function renderSavedAlerts() {
      const container = document.getElementById('savedAlertsList');

      if (savedAlerts.length === 0) {
        container.innerHTML = `
          <div class="empty-bot">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <p>Guarda alertas para que el bot las analice</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Usa el boton "Analizar" en cada alerta de la tabla</p>
          </div>
        `;
        return;
      }

      let html = '';

      savedAlerts.forEach((alert, index) => {
        const symbol = alert.symbol.replace('USDT', '');
        const savedDate = new Date(alert.savedAt);

        // Quick score (same as monitoring table)
        const quickScore = typeof alert.quickScore === 'number' ? alert.quickScore : null;
        const hasQuickScore = quickScore !== null && !isNaN(quickScore);
        const quickScoreClass = hasQuickScore && quickScore >= 70 ? 'high' : hasQuickScore && quickScore >= 50 ? 'medium' : 'low';

        // Similarity score (with success database)
        const botScore = alert.botScore || { score: null, message: 'Sin datos' };
        const hasSimScore = botScore.score !== null && !isNaN(botScore.score) && isFinite(botScore.score);
        const simScoreClass = hasSimScore && botScore.score >= 70 ? 'high' : hasSimScore && botScore.score >= 50 ? 'medium' : 'low';

        const newBadge = alert.isNew ? `<span class="new-badge">NUEVO</span>` : '';

        html += `
          <div class="saved-alert-card">
            <div class="saved-alert-header">
              <div>
                <div class="saved-alert-symbol">
                  ${symbol}/USDT ${newBadge}
                </div>
                <div style="display: flex; gap: 10px; margin-top: 8px;">
                  <div style="background: rgba(46, 213, 115, 0.1); border: 1px solid rgba(46, 213, 115, 0.3); border-radius: 8px; padding: 6px 12px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 0.7rem; color: #888;">SCORE</span>
                    <span class="score-badge ${quickScoreClass}" title="Score de la tabla de monitoreo" style="font-size: 0.85rem; margin: 0;">
                      ${hasQuickScore ? quickScore : 'N/A'}
                    </span>
                  </div>
                  <div style="background: rgba(108, 92, 231, 0.1); border: 1px solid rgba(108, 92, 231, 0.3); border-radius: 8px; padding: 6px 12px; display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 0.7rem; color: #888;">vs TUS EXITOSOS</span>
                    <span style="color: ${hasSimScore ? (botScore.score >= 70 ? '#2ed573' : botScore.score >= 50 ? '#ffa502' : '#ff4757') : '#888'}; font-weight: bold; font-size: 0.85rem;" title="${botScore.message || 'Similitud con tu base de datos'}">
                      ${hasSimScore ? botScore.score + '%' : 'N/A'}
                    </span>
                  </div>
                </div>
                <div class="saved-alert-time">
                  Guardado: ${savedDate.toLocaleDateString()} ${savedDate.toLocaleTimeString()}
                  ${alert.daysListed ? ` â€¢ ${alert.daysListed} dias en Binance` : ''}
                </div>
              </div>
              <div>
                ${isInSuccessDb(alert.symbol, alert.savedAt)
                  ? `<button class="mark-success-btn marked" disabled>En Base de Datos</button>`
                  : `<button class="mark-success-btn" onclick="markAsSuccess(${index})">Marcar Exitosa</button>`
                }
                <button class="delete-alert-btn" onclick="deleteSavedAlert(${index})">Eliminar</button>
              </div>
            </div>

            <div class="saved-alert-stats">
              <div class="saved-stat">
                <div class="saved-stat-label">Precio</div>
                <div class="saved-stat-value">$${formatPrice(alert.price)}</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Cambio 24h</div>
                <div class="saved-stat-value" style="color:#2ed573">+${alert.change24h.toFixed(2)}%</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">RSI</div>
                <div class="saved-stat-value" style="color:${alert.analysis.rsi >= 70 ? '#ff4757' : '#ffa502'}">
                  ${alert.analysis.rsi ? alert.analysis.rsi.toFixed(1) : 'N/A'}
                </div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Dist. Maximo</div>
                <div class="saved-stat-value">${alert.analysis.distanceFromHigh.toFixed(1)}%</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Volumen</div>
                <div class="saved-stat-value" style="color:#ffa502">${formatNumber(alert.volume)}</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Vol Spike</div>
                <div class="saved-stat-value">${alert.analysis.volumeSpike ? alert.analysis.volumeSpike.toFixed(1) + 'x' : 'N/A'}</div>
              </div>
            </div>

            <div class="bot-analysis">
              <div class="bot-analysis-title">
                ðŸ¤– Analisis del Bot
              </div>
              <div class="bot-analysis-text">
                <p style="margin-bottom: 15px;">${alert.analysis.summary}</p>
                <p><strong>Razones para shortear:</strong></p>
                <ul style="margin-left: 20px; margin-top: 8px;">
                  ${alert.analysis.reasons.map(r => `<li style="margin-bottom: 8px;">${r}</li>`).join('')}
                </ul>
              </div>
              <div class="indicator-tags">
                ${alert.analysis.indicators.map(i => `<span class="indicator-tag ${i.type}">${i.name}</span>`).join('')}
              </div>
            </div>

            ${hasSimScore ? `
            <div class="bot-similarity" style="margin-top: 15px; padding: 15px; background: rgba(108, 92, 231, 0.1); border: 1px solid rgba(108, 92, 231, 0.3); border-radius: 10px;">
              <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span style="font-size: 1.2rem;">ðŸ“Š</span>
                <strong style="color: #a29bfe;">Similitud con tus Exitosos: ${botScore.score}%</strong>
                <span style="color: ${botScore.score >= 70 ? '#2ed573' : botScore.score >= 50 ? '#ffa502' : '#ff4757'};">
                  (${botScore.message})
                </span>
              </div>
              ${botScore.avgPatterns ? `
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 0.85rem; color: #888;">
                <div>Patron Cambio: <span style="color: #fff;">+${botScore.avgPatterns.change?.toFixed(1) || 'N/A'}%</span></div>
                <div>Patron RSI: <span style="color: #fff;">${botScore.avgPatterns.rsi?.toFixed(0) || 'N/A'}</span></div>
                <div>Patron Vol: <span style="color: #fff;">${botScore.avgPatterns.volSpike?.toFixed(1) || 'N/A'}x</span></div>
                <div>Patron Dist: <span style="color: #fff;">${botScore.avgPatterns.distFromHigh?.toFixed(1) || 'N/A'}%</span></div>
              </div>
              ` : ''}
            </div>
            ` : `
            <div class="bot-similarity" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center;">
              <p style="color: #888; margin: 0;">ðŸ“Š Agrega trades exitosos a la base de datos para ver la similitud con tus patrones ganadores</p>
            </div>
            `}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Delete a saved alert
    function deleteSavedAlert(index) {
      savedAlerts.splice(index, 1);
      renderSavedAlerts();
    }

    // Clear all saved alerts
    function clearAllSavedAlerts() {
      if (confirm('Â¿Seguro que quieres eliminar todas las alertas guardadas?')) {
        savedAlerts = [];
        renderSavedAlerts();
      }
    }

    // Load saved alerts on page load
    renderSavedAlerts();

    // ==================== SUCCESS DATABASE SYSTEM ====================

    // Switch bot tabs
    function switchBotTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.bot-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.bot-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Refresh database view if switching to database tab
      if (tabName === 'database') {
        renderSuccessDatabase();
      }
    }

    // Mark alert as successful and add to database
    function markAsSuccess(index) {
      const alert = savedAlerts[index];
      if (!alert) return;

      // Check if already in database
      if (successDatabase.find(s => s.symbol === alert.symbol && s.savedAt === alert.savedAt)) {
        alert('Esta alerta ya esta en la base de datos de exitosas');
        return;
      }

      // Add to success database
      const successEntry = {
        ...alert,
        addedToDbAt: Date.now()
      };

      successDatabase.push(successEntry);
      localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));

      // Re-render
      renderSavedAlerts();
      renderSuccessDatabase();

      // Show confirmation
      const symbol = alert.symbol.replace('USDT', '');
      showNotification(`${symbol} agregado a la base de datos de shorts exitosos`);
    }

    // Remove from success database
    function removeFromSuccessDb(index) {
      successDatabase.splice(index, 1);
      localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));
      renderSuccessDatabase();
    }

    // Render success database
    function renderSuccessDatabase() {
      const container = document.getElementById('successDbList');

      // Update stats
      document.getElementById('dbTotalCount').textContent = successDatabase.length;

      if (successDatabase.length > 0) {
        const avgChange = successDatabase.reduce((sum, s) => sum + s.change24h, 0) / successDatabase.length;
        document.getElementById('dbAvgChange').textContent = '+' + avgChange.toFixed(1) + '%';

        const rsiAlerts = successDatabase.filter(s => s.analysis.rsi !== null);
        if (rsiAlerts.length > 0) {
          const avgRSI = rsiAlerts.reduce((sum, s) => sum + s.analysis.rsi, 0) / rsiAlerts.length;
          document.getElementById('dbAvgRSI').textContent = avgRSI.toFixed(1);
        }

        const volSpikeAlerts = successDatabase.filter(s => s.analysis.volumeSpike !== null);
        if (volSpikeAlerts.length > 0) {
          const avgVolSpike = volSpikeAlerts.reduce((sum, s) => sum + s.analysis.volumeSpike, 0) / volSpikeAlerts.length;
          document.getElementById('dbAvgVolSpike').textContent = avgVolSpike.toFixed(1) + 'x';
        }
      } else {
        document.getElementById('dbAvgChange').textContent = '-';
        document.getElementById('dbAvgRSI').textContent = '-';
        document.getElementById('dbAvgVolSpike').textContent = '-';
      }

      if (successDatabase.length === 0) {
        container.innerHTML = `
          <div class="empty-bot">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <p>No hay shorts exitosos en la base de datos</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Marca alertas como "Exitosa" para que el bot aprenda</p>
          </div>
        `;
        return;
      }

      let html = '';
      successDatabase.forEach((entry, index) => {
        const symbol = entry.symbol.replace('USDT', '');
        const date = new Date(entry.savedAt);

        // Handle different profit formats (USD from binance import, % from manual)
        let profitText = '';
        if (entry.profit) {
          if (entry.source === 'binance-import') {
            profitText = ` | +$${parseFloat(entry.profit).toFixed(2)} ganancia`;
          } else {
            profitText = ` | +${entry.profit}% ganancia`;
          }
        }

        // Badge for source type
        let sourceBadge = '';
        if (entry.isManual) {
          sourceBadge = '<span style="background: rgba(108, 92, 231, 0.2); color: #a29bfe; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px;">MANUAL</span>';
        } else if (entry.source === 'binance-import') {
          sourceBadge = '<span style="background: rgba(240, 185, 11, 0.2); color: #F0B90B; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px;">BINANCE</span>';
        }

        // Safe access to analysis fields
        const change = typeof entry.change24h === 'number' ? entry.change24h.toFixed(1) : (entry.change24h || 0);
        const rsi = entry.analysis && entry.analysis.rsi ? entry.analysis.rsi.toFixed(0) : 'N/A';
        const score = entry.analysis && entry.analysis.score ? entry.analysis.score : 'N/A';

        html += `
          <div class="success-db-item">
            <div class="success-db-item-info">
              <span class="success-db-symbol">${symbol}/USDT ${sourceBadge}</span>
              <span class="success-db-stats">
                +${change}% | RSI: ${rsi} |
                Score: ${score} | ${date.toLocaleDateString()}${profitText}
              </span>
            </div>
            <button class="remove-from-db-btn" onclick="removeFromSuccessDb(${index})">Eliminar</button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Consult alert against success database
    async function consultAlert() {
      const input = document.getElementById('consultSymbol');
      const resultDiv = document.getElementById('consultResult');
      const btn = document.getElementById('consultBtn');

      let symbol = input.value.trim().toUpperCase();
      if (!symbol) {
        alert('Ingresa un simbolo');
        return;
      }

      // Add USDT if not present
      if (!symbol.endsWith('USDT')) {
        symbol += 'USDT';
      }

      // Check if we have success patterns to compare
      if (successDatabase.length === 0) {
        resultDiv.innerHTML = `
          <div class="consult-verdict neutral">
            âš ï¸ Base de datos vacia
          </div>
          <p style="color: #888;">
            No hay shorts exitosos en la base de datos para comparar.
            Primero debes agregar alertas exitosas para que el bot pueda aprender de ellas.
          </p>
        `;
        resultDiv.classList.add('active');
        return;
      }

      // Disable button while loading
      btn.disabled = true;
      btn.textContent = 'Analizando...';

      try {
        // Fetch current data for the symbol
        const response = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`);

        if (!response.ok) {
          throw new Error('Simbolo no encontrado');
        }

        const coin = await response.json();

        // Fetch kline data
        const klineData = await fetchKlineData(symbol);

        // Analyze the coin
        const analysis = await analyzeForShort(coin, klineData);

        // Compare with success database patterns
        const comparison = compareWithSuccessPatterns(coin, analysis);

        // Render result
        renderConsultResult(coin, analysis, comparison);

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="consult-verdict negative">
            âŒ Error
          </div>
          <p style="color: #888;">${error.message}. Verifica que el simbolo sea correcto y este listado en Binance Futures.</p>
        `;
        resultDiv.classList.add('active');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Consultar al Bot';
      }
    }

    // Compare new alert with success patterns
    function compareWithSuccessPatterns(coin, analysis) {
      const change = parseFloat(coin.priceChangePercent);
      const rsi = analysis.rsi;
      const volSpike = analysis.volumeSpike;
      const distFromHigh = analysis.distanceFromHigh;

      // Calculate average patterns from success database
      const avgChange = successDatabase.reduce((sum, s) => sum + s.change24h, 0) / successDatabase.length;

      const rsiAlerts = successDatabase.filter(s => s.analysis.rsi !== null);
      const avgRSI = rsiAlerts.length > 0
        ? rsiAlerts.reduce((sum, s) => sum + s.analysis.rsi, 0) / rsiAlerts.length
        : null;

      const volSpikeAlerts = successDatabase.filter(s => s.analysis.volumeSpike !== null);
      const avgVolSpike = volSpikeAlerts.length > 0
        ? volSpikeAlerts.reduce((sum, s) => sum + s.analysis.volumeSpike, 0) / volSpikeAlerts.length
        : null;

      const avgDistFromHigh = successDatabase.reduce((sum, s) => sum + s.analysis.distanceFromHigh, 0) / successDatabase.length;
      const avgScore = successDatabase.reduce((sum, s) => sum + s.analysis.score, 0) / successDatabase.length;

      // Calculate similarity scores for each indicator
      const similarities = [];
      let totalSimilarity = 0;
      let factorCount = 0;

      // Change similarity
      const changeDeviation = Math.abs(change - avgChange) / avgChange;
      const changeSimilarity = Math.max(0, 100 - changeDeviation * 50);
      similarities.push({ name: 'Cambio 24h', value: changeSimilarity, current: `+${change.toFixed(1)}%`, pattern: `+${avgChange.toFixed(1)}%` });
      totalSimilarity += changeSimilarity;
      factorCount++;

      // RSI similarity
      if (rsi !== null && avgRSI !== null) {
        const rsiDeviation = Math.abs(rsi - avgRSI) / avgRSI;
        const rsiSimilarity = Math.max(0, 100 - rsiDeviation * 100);
        similarities.push({ name: 'RSI', value: rsiSimilarity, current: rsi.toFixed(1), pattern: avgRSI.toFixed(1) });
        totalSimilarity += rsiSimilarity;
        factorCount++;
      }

      // Volume spike similarity
      if (volSpike !== null && avgVolSpike !== null) {
        const volDeviation = Math.abs(volSpike - avgVolSpike) / avgVolSpike;
        const volSimilarity = Math.max(0, 100 - volDeviation * 50);
        similarities.push({ name: 'Vol Spike', value: volSimilarity, current: volSpike.toFixed(1) + 'x', pattern: avgVolSpike.toFixed(1) + 'x' });
        totalSimilarity += volSimilarity;
        factorCount++;
      }

      // Distance from high similarity
      const distDeviation = Math.abs(distFromHigh - avgDistFromHigh) / (avgDistFromHigh || 1);
      const distSimilarity = Math.max(0, 100 - distDeviation * 100);
      similarities.push({ name: 'Dist. Maximo', value: distSimilarity, current: distFromHigh.toFixed(1) + '%', pattern: avgDistFromHigh.toFixed(1) + '%' });
      totalSimilarity += distSimilarity;
      factorCount++;

      // Score similarity
      const scoreDeviation = Math.abs(analysis.score - avgScore) / avgScore;
      const scoreSimilarity = Math.max(0, 100 - scoreDeviation * 50);
      similarities.push({ name: 'Score', value: scoreSimilarity, current: analysis.score, pattern: avgScore.toFixed(0) });
      totalSimilarity += scoreSimilarity;
      factorCount++;

      const overallSimilarity = totalSimilarity / factorCount;

      // Find most similar successful shorts
      const patternMatches = successDatabase.map(entry => {
        let matchScore = 0;
        let factors = 0;

        // Compare change
        const changeDiff = Math.abs(change - entry.change24h) / entry.change24h;
        matchScore += Math.max(0, 100 - changeDiff * 50);
        factors++;

        // Compare RSI
        if (rsi !== null && entry.analysis.rsi !== null) {
          const rsiDiff = Math.abs(rsi - entry.analysis.rsi) / entry.analysis.rsi;
          matchScore += Math.max(0, 100 - rsiDiff * 100);
          factors++;
        }

        // Compare score
        const scoreDiff = Math.abs(analysis.score - entry.analysis.score) / entry.analysis.score;
        matchScore += Math.max(0, 100 - scoreDiff * 50);
        factors++;

        return {
          symbol: entry.symbol.replace('USDT', ''),
          similarity: matchScore / factors,
          change: entry.change24h,
          score: entry.analysis.score
        };
      }).sort((a, b) => b.similarity - a.similarity).slice(0, 3);

      return {
        overallSimilarity,
        similarities,
        patternMatches,
        avgScore,
        recommendation: overallSimilarity >= 70 ? 'positive' : overallSimilarity >= 50 ? 'neutral' : 'negative'
      };
    }

    // Render consult result
    function renderConsultResult(coin, analysis, comparison) {
      const resultDiv = document.getElementById('consultResult');
      const symbol = coin.symbol.replace('USDT', '');

      let verdictIcon, verdictText, verdictClass;
      if (comparison.recommendation === 'positive') {
        verdictIcon = 'âœ…';
        verdictText = 'BUENA CANDIDATA PARA SHORT';
        verdictClass = 'positive';
      } else if (comparison.recommendation === 'neutral') {
        verdictIcon = 'âš ï¸';
        verdictText = 'CANDIDATA MODERADA';
        verdictClass = 'neutral';
      } else {
        verdictIcon = 'âŒ';
        verdictText = 'NO COINCIDE CON PATRONES EXITOSOS';
        verdictClass = 'negative';
      }

      let html = `
        <div class="consult-verdict ${verdictClass}">
          ${verdictIcon} ${symbol}/USDT - ${verdictText}
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px;">
          <div class="db-stat">
            <div class="db-stat-value" style="color: ${comparison.overallSimilarity >= 70 ? '#2ed573' : comparison.overallSimilarity >= 50 ? '#ffa502' : '#ff4757'}">${comparison.overallSimilarity.toFixed(0)}%</div>
            <div class="db-stat-label">Similitud</div>
          </div>
          <div class="db-stat">
            <div class="db-stat-value" style="color: #2ed573">+${parseFloat(coin.priceChangePercent).toFixed(1)}%</div>
            <div class="db-stat-label">Cambio 24h</div>
          </div>
          <div class="db-stat">
            <div class="db-stat-value" style="color: ${analysis.rsi >= 70 ? '#ff4757' : '#ffa502'}">${analysis.rsi ? analysis.rsi.toFixed(0) : 'N/A'}</div>
            <div class="db-stat-label">RSI</div>
          </div>
          <div class="db-stat">
            <div class="db-stat-value">${analysis.score}</div>
            <div class="db-stat-label">Score</div>
          </div>
        </div>

        <div class="bot-analysis" style="margin-bottom: 20px;">
          <div class="bot-analysis-title">ðŸ¤– Veredicto del Bot</div>
          <div class="bot-analysis-text">
            ${comparison.overallSimilarity >= 70
              ? `<p><strong class="positive">Esta alerta tiene un ${comparison.overallSimilarity.toFixed(0)}% de similitud con tus shorts exitosos.</strong></p>
                 <p>Los indicadores actuales coinciden bien con los patrones que historicamente te han funcionado. El bot considera que es una <strong>buena oportunidad</strong> basandose en tu historial.</p>`
              : comparison.overallSimilarity >= 50
              ? `<p><strong class="warning">Similitud moderada del ${comparison.overallSimilarity.toFixed(0)}% con tus patrones exitosos.</strong></p>
                 <p>Algunos indicadores coinciden pero otros difieren. Considera esperar mas confirmacion o reducir el tamaÃ±o de la posicion.</p>`
              : `<p><strong style="color:#ff4757">Baja similitud (${comparison.overallSimilarity.toFixed(0)}%) con tus shorts exitosos.</strong></p>
                 <p>Esta alerta no coincide con los patrones que te han funcionado antes. El bot sugiere cautela o buscar otra oportunidad.</p>`
            }
          </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
          <p style="font-size: 0.9rem; font-weight: 600; color: #a29bfe; margin-bottom: 12px;">Comparacion de Indicadores</p>
          <table style="width: 100%; font-size: 0.85rem;">
            <tr style="color: #888;">
              <th style="text-align: left; padding: 8px 0;">Indicador</th>
              <th style="text-align: center;">Actual</th>
              <th style="text-align: center;">Patron Exitoso</th>
              <th style="text-align: right;">Similitud</th>
            </tr>
            ${comparison.similarities.map(s => `
              <tr style="border-top: 1px solid rgba(255,255,255,0.05);">
                <td style="padding: 8px 0;">${s.name}</td>
                <td style="text-align: center; color: #fff;">${s.current}</td>
                <td style="text-align: center; color: #a29bfe;">${s.pattern}</td>
                <td style="text-align: right; color: ${s.value >= 70 ? '#2ed573' : s.value >= 50 ? '#ffa502' : '#ff4757'}">${s.value.toFixed(0)}%</td>
              </tr>
            `).join('')}
          </table>
        </div>

        ${comparison.patternMatches.length > 0 ? `
          <div class="pattern-matches">
            <p class="pattern-match-title">Shorts exitosos mas similares</p>
            ${comparison.patternMatches.map(m => `
              <div class="pattern-match-item">
                <span><strong>${m.symbol}</strong> - +${m.change.toFixed(1)}% (Score: ${m.score})</span>
                <span class="pattern-similarity">${m.similarity.toFixed(0)}% similar</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;

      resultDiv.innerHTML = html;
      resultDiv.classList.add('active');
    }

    // Show notification
    function showNotification(message) {
      const popup = document.getElementById('alertPopup');
      document.getElementById('alertTitle').textContent = 'Exito';
      document.getElementById('alertMessage').textContent = message;
      popup.classList.remove('hidden');
      popup.style.background = 'linear-gradient(135deg, #2ed573, #27ae60)';

      setTimeout(() => {
        popup.classList.add('hidden');
        popup.style.background = '';
      }, 3000);
    }

    // Initialize database view
    renderSuccessDatabase();

    // ==================== MANUAL ENTRY SYSTEM ====================

    // Toggle manual entry form
    function toggleManualEntry() {
      const form = document.getElementById('manualEntryForm');
      const toggle = document.getElementById('manualEntryToggle');

      if (form.style.display === 'none') {
        form.style.display = 'block';
        toggle.classList.add('open');
      } else {
        form.style.display = 'none';
        toggle.classList.remove('open');
      }
    }

    // Fetch historical kline data
    async function fetchHistoricalKlines(symbol, timestamp) {
      try {
        // Get klines from 50 hours before the timestamp to have enough data for RSI
        const startTime = timestamp - (50 * 60 * 60 * 1000);
        const endTime = timestamp + (2 * 60 * 60 * 1000);

        const response = await fetch(
          `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&startTime=${startTime}&endTime=${endTime}&limit=100`
        );

        if (!response.ok) throw new Error('Error obteniendo datos historicos');
        return await response.json();
      } catch (error) {
        console.error('Error fetching historical klines:', error);
        return null;
      }
    }

    // Fetch historical 24h ticker (approximate by using klines)
    async function getHistorical24hData(symbol, timestamp, klines) {
      if (!klines || klines.length < 24) return null;

      // Find the candle closest to our timestamp
      let targetIndex = klines.length - 1;
      for (let i = 0; i < klines.length; i++) {
        if (klines[i][0] >= timestamp) {
          targetIndex = i;
          break;
        }
      }

      // Get data from 24 hours before
      const startIndex = Math.max(0, targetIndex - 24);
      const relevantKlines = klines.slice(startIndex, targetIndex + 1);

      if (relevantKlines.length < 2) return null;

      const high24h = Math.max(...relevantKlines.map(k => parseFloat(k[2])));
      const low24h = Math.min(...relevantKlines.map(k => parseFloat(k[3])));
      const currentClose = parseFloat(relevantKlines[relevantKlines.length - 1][4]);
      const openPrice24hAgo = parseFloat(relevantKlines[0][1]);
      const change24h = ((currentClose - openPrice24hAgo) / openPrice24hAgo) * 100;
      const totalVolume = relevantKlines.reduce((sum, k) => sum + parseFloat(k[5]), 0);

      return {
        high24h,
        low24h,
        currentPrice: currentClose,
        change24h,
        volume: totalVolume
      };
    }

    // Add manual entry
    async function addManualEntry() {
      const symbolInput = document.getElementById('manualSymbol');
      const dateInput = document.getElementById('manualDate');
      const timeInput = document.getElementById('manualTime');
      const changeInput = document.getElementById('manualChange');
      const priceInput = document.getElementById('manualPrice');
      const profitInput = document.getElementById('manualProfit');
      const resultDiv = document.getElementById('manualEntryResult');
      const btn = document.getElementById('manualAddBtn');

      // Validate required fields
      let symbol = symbolInput.value.trim().toUpperCase();
      const dateStr = dateInput.value;

      if (!symbol || !dateStr) {
        resultDiv.innerHTML = '<p style="color: #ff4757;">Por favor completa el simbolo y la fecha.</p>';
        resultDiv.className = 'manual-entry-result active error';
        return;
      }

      // Add USDT if needed
      if (!symbol.endsWith('USDT')) {
        symbol += 'USDT';
      }

      // Parse date and time
      const timeStr = timeInput.value || '12:00';
      const dateTimeStr = `${dateStr}T${timeStr}:00`;
      const timestamp = new Date(dateTimeStr).getTime();

      // Check if date is not in the future
      if (timestamp > Date.now()) {
        resultDiv.innerHTML = '<p style="color: #ff4757;">La fecha no puede ser futura.</p>';
        resultDiv.className = 'manual-entry-result active error';
        return;
      }

      // Disable button
      btn.disabled = true;
      btn.textContent = 'Analizando datos historicos...';

      try {
        // Fetch historical data
        const klines = await fetchHistoricalKlines(symbol, timestamp);

        if (!klines || klines.length < 20) {
          throw new Error('No se encontraron suficientes datos historicos para esta fecha. Intenta con una fecha mas reciente o verifica el simbolo.');
        }

        // Get historical 24h data
        const historical24h = await getHistorical24hData(symbol, timestamp, klines);

        // Calculate RSI from historical data
        const rsi = calculateRSI(klines.slice(0, -1)); // Use candles before the target

        // Calculate volume spike from historical data
        const volumeSpike = calculateVolumeSpike(klines.slice(0, -1));

        // Use user-provided change or calculated one
        const change24h = changeInput.value ? parseFloat(changeInput.value) : (historical24h?.change24h || 0);
        const entryPrice = priceInput.value ? parseFloat(priceInput.value) : (historical24h?.currentPrice || 0);
        const profit = profitInput.value ? parseFloat(profitInput.value) : null;

        // Build coin-like object for analysis
        const historicalCoin = {
          symbol: symbol,
          lastPrice: entryPrice.toString(),
          priceChangePercent: change24h.toString(),
          highPrice: (historical24h?.high24h || entryPrice * 1.1).toString(),
          lowPrice: (historical24h?.low24h || entryPrice * 0.9).toString(),
          quoteVolume: (historical24h?.volume || 50000000).toString()
        };

        // Analyze the historical data
        const analysis = await analyzeForShort(historicalCoin, klines);

        // Create success entry
        const successEntry = {
          symbol: symbol,
          savedAt: timestamp,
          addedToDbAt: Date.now(),
          price: entryPrice,
          change24h: change24h,
          high24h: historical24h?.high24h || entryPrice,
          low24h: historical24h?.low24h || entryPrice,
          volume: historical24h?.volume || 0,
          profit: profit,
          isManual: true,
          isNew: false,
          daysListed: null,
          analysis: analysis
        };

        // Add to database
        successDatabase.push(successEntry);
        localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));

        // Show result
        const shortSymbol = symbol.replace('USDT', '');
        const dateFormatted = new Date(timestamp).toLocaleDateString();

        resultDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
            <span style="font-size: 2rem;">âœ…</span>
            <div>
              <div style="font-size: 1.2rem; font-weight: 700; color: #2ed573;">${shortSymbol}/USDT agregado exitosamente</div>
              <div style="color: #888; font-size: 0.9rem;">Fecha: ${dateFormatted} ${profit ? `| Ganancia: +${profit}%` : ''}</div>
            </div>
          </div>

          <div class="historical-analysis">
            <div class="historical-analysis-title">
              ðŸ” Analisis Historico - Por que fue buen short:
            </div>
            <div class="bot-analysis-text">
              <p style="margin-bottom: 15px;">
                <strong>Score del momento: ${analysis.score}/100</strong>
                ${analysis.score >= 70 ? ' - Excelente setup' : analysis.score >= 50 ? ' - Buen setup' : ' - Setup moderado'}
              </p>
              <ul style="margin-left: 20px;">
                ${analysis.reasons.map(r => `<li style="margin-bottom: 8px;">${r}</li>`).join('')}
              </ul>
            </div>
            <div class="indicator-tags" style="margin-top: 15px;">
              ${analysis.indicators.map(i => `<span class="indicator-tag ${i.type}">${i.name}</span>`).join('')}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 20px;">
            <div class="db-stat">
              <div class="db-stat-value" style="color: #2ed573">+${change24h.toFixed(1)}%</div>
              <div class="db-stat-label">Cambio 24h</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" style="color: ${rsi >= 70 ? '#ff4757' : '#ffa502'}">${rsi ? rsi.toFixed(0) : 'N/A'}</div>
              <div class="db-stat-label">RSI</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value">${volumeSpike ? volumeSpike.toFixed(1) + 'x' : 'N/A'}</div>
              <div class="db-stat-label">Vol Spike</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value">${analysis.score}</div>
              <div class="db-stat-label">Score</div>
            </div>
          </div>
        `;
        resultDiv.className = 'manual-entry-result active success';

        // Clear form
        symbolInput.value = '';
        dateInput.value = '';
        changeInput.value = '';
        priceInput.value = '';
        profitInput.value = '';

        // Refresh database list
        renderSuccessDatabase();

      } catch (error) {
        resultDiv.innerHTML = `
          <p style="color: #ff4757; font-weight: 600;">Error al analizar</p>
          <p style="color: #888; margin-top: 8px;">${error.message}</p>
        `;
        resultDiv.className = 'manual-entry-result active error';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analizar y Agregar a Base de Datos';
      }
    }

    // PWA Install
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallButton();
    });

    function showInstallButton() {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary install-btn';
      btn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        Instalar App
      `;
      btn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:1000;padding:14px 24px;gap:8px;box-shadow:0 10px 40px rgba(255,71,87,0.4);';
      btn.onclick = installApp;
      document.body.appendChild(btn);
    }

    async function installApp() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        document.querySelector('.install-btn')?.remove();
      }
      deferredPrompt = null;
    }

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed:', err));
      });
    }

    // Request notification permission on load
    window.addEventListener('load', () => {
      requestNotificationPermission();
      loadBinanceCredentials();
    });

    // Load saved Binance credentials
    function loadBinanceCredentials() {
      const apiKey = localStorage.getItem('binanceApiKey');
      const apiSecret = localStorage.getItem('binanceApiSecret');

      if (apiKey) {
        document.getElementById('binanceApiKey').value = apiKey;
        binanceApiKey = apiKey;
      }
      if (apiSecret) {
        document.getElementById('binanceApiSecret').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        binanceApiSecret = apiSecret;
      }
    }

    // Save Binance credentials
    function saveBinanceCredentials() {
      const apiKey = document.getElementById('binanceApiKey').value.trim();
      const apiSecret = document.getElementById('binanceApiSecret').value.trim();

      if (!apiKey || !apiSecret || apiSecret === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
        showBinanceStatus('Ingresa ambas credenciales', 'error');
        return;
      }

      localStorage.setItem('binanceApiKey', apiKey);
      localStorage.setItem('binanceApiSecret', apiSecret);
      binanceApiKey = apiKey;
      binanceApiSecret = apiSecret;

      document.getElementById('binanceApiSecret').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      showBinanceStatus('Credenciales guardadas correctamente', 'success');
    }

    // Clear Binance credentials
    function clearBinanceCredentials() {
      localStorage.removeItem('binanceApiKey');
      localStorage.removeItem('binanceApiSecret');
      binanceApiKey = '';
      binanceApiSecret = '';

      document.getElementById('binanceApiKey').value = '';
      document.getElementById('binanceApiSecret').value = '';
      showBinanceStatus('Credenciales eliminadas', 'info');
    }

    // Show Binance connection status
    function showBinanceStatus(message, type) {
      const statusDiv = document.getElementById('binanceConnectionStatus');
      const colors = {
        success: { bg: 'rgba(46, 213, 115, 0.1)', border: '#2ed573', text: '#2ed573' },
        error: { bg: 'rgba(255, 71, 87, 0.1)', border: '#ff4757', text: '#ff4757' },
        info: { bg: 'rgba(108, 92, 231, 0.1)', border: '#a29bfe', text: '#a29bfe' }
      };
      const color = colors[type] || colors.info;

      statusDiv.style.display = 'block';
      statusDiv.style.background = color.bg;
      statusDiv.style.border = `1px solid ${color.border}`;
      statusDiv.innerHTML = `<p style="color: ${color.text}; margin: 0;">${message}</p>`;

      setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
    }

    // Generate HMAC-SHA256 signature
    async function generateSignature(queryString, secret) {
      const encoder = new TextEncoder();
      const keyData = encoder.encode(secret);
      const messageData = encoder.encode(queryString);

      const key = await crypto.subtle.importKey(
        'raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
      );

      const signature = await crypto.subtle.sign('HMAC', key, messageData);
      return Array.from(new Uint8Array(signature))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // Test Binance connection
    async function testBinanceConnection() {
      if (!binanceApiKey || !binanceApiSecret) {
        showBinanceStatus('Primero guarda tus credenciales', 'error');
        return;
      }

      try {
        const timestamp = Date.now();
        const queryString = `timestamp=${timestamp}`;
        const signature = await generateSignature(queryString, binanceApiSecret);

        const response = await fetch(
          `https://fapi.binance.com/fapi/v2/account?${queryString}&signature=${signature}`,
          { headers: { 'X-MBX-APIKEY': binanceApiKey } }
        );

        if (response.ok) {
          const data = await response.json();
          const balance = parseFloat(data.totalWalletBalance).toFixed(2);
          showBinanceStatus(`Conexion exitosa! Balance: $${balance} USDT`, 'success');
        } else {
          const error = await response.json();
          const errorMsg = error.msg || 'API Key invalida';

          // Check if error contains IP address (Binance IP restriction error)
          const ipMatch = errorMsg.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/);

          if (ipMatch) {
            // Show IP prominently for the user to copy
            showBinanceStatusWithIP(errorMsg, ipMatch[1]);
          } else {
            showBinanceStatus(`Error: ${errorMsg}`, 'error');
          }
        }
      } catch (error) {
        showBinanceStatus(`Error de conexion: ${error.message}`, 'error');
      }
    }

    // Show error with IP address prominently displayed
    function showBinanceStatusWithIP(errorMsg, ipAddress) {
      const statusDiv = document.getElementById('binanceConnectionStatus');

      statusDiv.style.display = 'block';
      statusDiv.style.background = 'rgba(255, 71, 87, 0.1)';
      statusDiv.style.border = '1px solid #ff4757';
      statusDiv.innerHTML = `
        <p style="color: #ff4757; margin: 0 0 15px 0; font-size: 0.9rem;">${errorMsg}</p>
        <div style="background: rgba(240, 185, 11, 0.15); border: 2px solid #F0B90B; border-radius: 10px; padding: 15px; text-align: center;">
          <p style="color: #F0B90B; margin: 0 0 8px 0; font-size: 0.85rem;">
            <strong>ðŸ‘† Agrega esta IP a tu API Key en Binance:</strong>
          </p>
          <p id="binanceRequiredIP" style="color: #fff; font-family: monospace; font-size: 1.4rem; margin: 0 0 10px 0; cursor: pointer; user-select: all;" onclick="copyBinanceIP()" title="Click para copiar">
            ${ipAddress}
          </p>
          <button onclick="copyBinanceIP()" style="background: #F0B90B; color: #000; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
            ðŸ“‹ Copiar IP
          </button>
          <p style="color: #888; margin: 10px 0 0 0; font-size: 0.8rem;">
            Ve a Binance > API Management > Editar > Restricciones de IP > Agregar esta IP
          </p>
        </div>
      `;
      // Don't auto-hide when showing IP info
    }

    // Copy Binance required IP
    function copyBinanceIP() {
      const ipElement = document.getElementById('binanceRequiredIP');
      if (ipElement) {
        const ip = ipElement.textContent.trim();
        navigator.clipboard.writeText(ip).then(() => {
          const originalText = ipElement.textContent;
          ipElement.textContent = 'âœ“ Copiado!';
          ipElement.style.color = '#2ed573';
          setTimeout(() => {
            ipElement.textContent = originalText;
            ipElement.style.color = '#fff';
          }, 2000);
        });
      }
    }

    // Import trades from Binance
    async function importBinanceTrades() {
      if (!binanceApiKey || !binanceApiSecret) {
        showBinanceStatus('Primero guarda tus credenciales', 'error');
        return;
      }

      const btn = document.getElementById('importTradesBtn');
      const progressDiv = document.getElementById('importProgress');
      const progressBar = document.getElementById('importProgressBar');
      const progressText = document.getElementById('importProgressText');
      const resultDiv = document.getElementById('importResult');

      const days = parseInt(document.getElementById('importDays').value);
      const minProfitUsd = parseFloat(document.getElementById('minProfit').value);

      btn.disabled = true;
      btn.textContent = 'Importando...';
      progressDiv.style.display = 'block';
      resultDiv.style.display = 'none';

      try {
        const endTime = Date.now();
        const startTime = endTime - (days * 24 * 60 * 60 * 1000);

        progressText.textContent = 'Obteniendo historial de PnL...';
        progressBar.style.width = '10%';

        // Fetch all income data (may need multiple requests due to 1000 limit)
        let allIncomeData = [];
        let currentStartTime = startTime;
        let hasMore = true;

        while (hasMore) {
          const timestamp = Date.now();
          const queryString = `incomeType=REALIZED_PNL&startTime=${currentStartTime}&endTime=${endTime}&limit=1000&timestamp=${timestamp}`;
          const signature = await generateSignature(queryString, binanceApiSecret);

          const response = await fetch(
            `https://fapi.binance.com/fapi/v1/income?${queryString}&signature=${signature}`,
            { headers: { 'X-MBX-APIKEY': binanceApiKey } }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.msg || 'Error al obtener historial');
          }

          const data = await response.json();
          allIncomeData = allIncomeData.concat(data);

          if (data.length === 1000) {
            // May have more data, update start time
            currentStartTime = parseInt(data[data.length - 1].time) + 1;
            progressText.textContent = `Obteniendo historial... (${allIncomeData.length} registros)`;
          } else {
            hasMore = false;
          }
        }

        progressBar.style.width = '30%';
        progressText.textContent = `Analizando ${allIncomeData.length} registros de PnL...`;

        // Group by symbol and calculate total profit per symbol
        const tradesBySymbol = {};

        allIncomeData.forEach(income => {
          const pnl = parseFloat(income.income);
          const symbol = income.symbol;

          if (!symbol || !symbol.endsWith('USDT')) return;

          if (!tradesBySymbol[symbol]) {
            tradesBySymbol[symbol] = {
              totalPnl: 0,
              trades: [],
              positiveTrades: 0,
              negativeTrades: 0
            };
          }

          tradesBySymbol[symbol].totalPnl += pnl;
          tradesBySymbol[symbol].trades.push(income);

          if (pnl > 0) {
            tradesBySymbol[symbol].positiveTrades++;
          } else {
            tradesBySymbol[symbol].negativeTrades++;
          }
        });

        // Filter symbols with positive total PnL and minimum profit
        const profitableSymbols = Object.entries(tradesBySymbol)
          .filter(([symbol, data]) => data.totalPnl >= minProfitUsd)
          .sort((a, b) => b[1].totalPnl - a[1].totalPnl);

        progressBar.style.width = '50%';
        progressText.textContent = `Encontrados ${profitableSymbols.length} simbolos con ganancia. Importando...`;

        // Load current success database (update global variable)
        successDatabase = JSON.parse(localStorage.getItem('successShortDatabase') || '[]');
        let imported = 0;
        let skipped = 0;

        for (let i = 0; i < profitableSymbols.length; i++) {
          const [symbol, data] = profitableSymbols[i];

          // Get the most recent trade for this symbol
          const sortedTrades = data.trades.sort((a, b) => parseInt(b.time) - parseInt(a.time));
          const mostRecentTrade = sortedTrades[0];
          const tradeTime = parseInt(mostRecentTrade.time);

          // Check if already exists
          const exists = successDatabase.some(entry =>
            entry.symbol === symbol &&
            Math.abs(entry.savedAt - tradeTime) < 24 * 60 * 60 * 1000 // Within 24 hours
          );

          if (exists) {
            skipped++;
            continue;
          }

          try {
            // Try to get historical data for analysis
            let analysis = {
              rsi: null,
              volumeSpike: null,
              distanceFromHigh: 5,
              score: 50 // Default score
            };
            let change24h = 30; // Default
            let entryPrice = 0;

            try {
              const klines = await fetchHistoricalKlines(symbol, tradeTime);
              if (klines && klines.length > 0) {
                const historicalData = await getHistorical24hData(symbol, tradeTime, klines);
                if (historicalData) {
                  change24h = historicalData.change24h || 30;
                  entryPrice = historicalData.price || 0;
                  analysis.rsi = historicalData.rsi;
                  analysis.volumeSpike = historicalData.volumeSpike;

                  // Calculate a simple score based on available data
                  let score = 40;
                  if (analysis.rsi && analysis.rsi > 70) score += 20;
                  if (analysis.volumeSpike && analysis.volumeSpike > 2) score += 15;
                  if (change24h > 50) score += 15;
                  if (change24h > 30) score += 10;
                  analysis.score = Math.min(score, 100);
                }
              }
            } catch (e) {
              console.log(`Could not fetch historical data for ${symbol}, using defaults`);
            }

            // Create entry in the format expected by the bot
            const successEntry = {
              symbol: symbol,
              savedAt: tradeTime,
              change24h: Math.abs(change24h),
              price: entryPrice,
              volume: 0,
              analysis: analysis,
              profit: data.totalPnl,
              source: 'binance-import',
              importedAt: Date.now(),
              tradesCount: data.trades.length,
              winRate: ((data.positiveTrades / data.trades.length) * 100).toFixed(1)
            };

            successDatabase.push(successEntry);
            imported++;

            // Small delay to avoid rate limiting
            if (i % 5 === 0) {
              await new Promise(r => setTimeout(r, 100));
            }

          } catch (e) {
            console.log(`Error importing ${symbol}:`, e);
          }

          progressBar.style.width = `${50 + (50 * (i + 1) / profitableSymbols.length)}%`;
          progressText.textContent = `Importando ${i + 1}/${profitableSymbols.length}...`;
        }

        // Save to localStorage
        localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));
        progressBar.style.width = '100%';

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div style="background: rgba(46, 213, 115, 0.1); border: 1px solid #2ed573; border-radius: 10px; padding: 20px;">
            <h4 style="color: #2ed573; margin-bottom: 10px;">Importacion Completada</h4>
            <p style="color: #fff;">Se importaron <strong>${imported}</strong> trades exitosos a la base de datos.</p>
            <p style="color: #888; font-size: 0.85rem; margin-top: 8px;">
              Registros de PnL analizados: ${allIncomeData.length}<br>
              Simbolos con ganancia: ${profitableSymbols.length}<br>
              Nuevos importados: ${imported}<br>
              Ya existentes (omitidos): ${skipped}
            </p>
          </div>
        `;

        // Refresh database view
        renderSuccessDatabase();
        updateDbStats();

      } catch (error) {
        console.error('Import error:', error);
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div style="background: rgba(255, 71, 87, 0.1); border: 1px solid #ff4757; border-radius: 10px; padding: 20px;">
            <h4 style="color: #ff4757; margin-bottom: 10px;">Error en la importacion</h4>
            <p style="color: #fff;">${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'ðŸ“¥ Importar Shorts Exitosos';
        setTimeout(() => { progressDiv.style.display = 'none'; }, 3000);
      }
    }

    // Export database to JSON file
    function exportDatabase() {
      const statusDiv = document.getElementById('importExportStatus');

      try {
        const data = localStorage.getItem('successShortDatabase') || '[]';
        const database = JSON.parse(data);

        if (database.length === 0) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = 'rgba(255, 71, 87, 0.1)';
          statusDiv.style.border = '1px solid #ff4757';
          statusDiv.innerHTML = '<p style="color: #ff4757; margin: 0;">âŒ No hay datos para exportar</p>';
          setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
          return;
        }

        const exportData = {
          version: '2.0',
          exportedAt: new Date().toISOString(),
          count: database.length,
          data: database
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pasi-alerts-db-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(46, 213, 115, 0.1)';
        statusDiv.style.border = '1px solid #2ed573';
        statusDiv.innerHTML = `
          <p style="color: #2ed573; margin: 0 0 8px 0;">âœ… Base de datos exportada (${database.length} registros)</p>
          <p style="color: #888; margin: 0; font-size: 0.85rem;">
            ðŸ“± Para transferir al celular: EnvÃ­a el archivo por <strong>Bluetooth</strong>, WhatsApp, Email o Drive
          </p>
        `;
        setTimeout(() => { statusDiv.style.display = 'none'; }, 8000);

      } catch (error) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(255, 71, 87, 0.1)';
        statusDiv.style.border = '1px solid #ff4757';
        statusDiv.innerHTML = `<p style="color: #ff4757; margin: 0;">âŒ Error al exportar: ${error.message}</p>`;
        setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
      }
    }

    // Import database from JSON file
    function importDatabase(event) {
      const statusDiv = document.getElementById('importExportStatus');
      const file = event.target.files[0];

      if (!file) return;

      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          const content = JSON.parse(e.target.result);

          // Validate format
          let dataToImport = [];
          if (content.data && Array.isArray(content.data)) {
            // New format with metadata
            dataToImport = content.data;
          } else if (Array.isArray(content)) {
            // Old format (direct array)
            dataToImport = content;
          } else {
            throw new Error('Formato de archivo no vÃ¡lido');
          }

          if (dataToImport.length === 0) {
            throw new Error('El archivo no contiene datos');
          }

          // Ask user how to handle existing data
          const existingData = JSON.parse(localStorage.getItem('successShortDatabase') || '[]');

          if (existingData.length > 0) {
            const action = confirm(
              `Ya tienes ${existingData.length} registros.\n\n` +
              `Â¿Quieres COMBINAR los datos? (${existingData.length} existentes + ${dataToImport.length} nuevos)\n\n` +
              `OK = Combinar\nCancelar = Reemplazar todo`
            );

            if (action) {
              // Merge: add new entries that don't exist
              const existingSymbols = new Set(existingData.map(e => e.symbol + '_' + e.savedAt));
              const newEntries = dataToImport.filter(e => !existingSymbols.has(e.symbol + '_' + e.savedAt));
              dataToImport = [...existingData, ...newEntries];

              statusDiv.innerHTML = `
                <p style="color: #2ed573; margin: 0 0 8px 0;">âœ… Datos combinados correctamente</p>
                <p style="color: #888; margin: 0; font-size: 0.85rem;">
                  ${existingData.length} existentes + ${newEntries.length} nuevos = ${dataToImport.length} total
                </p>
              `;
            } else {
              statusDiv.innerHTML = `
                <p style="color: #2ed573; margin: 0 0 8px 0;">âœ… Base de datos reemplazada</p>
                <p style="color: #888; margin: 0; font-size: 0.85rem;">
                  ${dataToImport.length} registros importados
                </p>
              `;
            }
          } else {
            statusDiv.innerHTML = `
              <p style="color: #2ed573; margin: 0 0 8px 0;">âœ… Base de datos importada</p>
              <p style="color: #888; margin: 0; font-size: 0.85rem;">
                ${dataToImport.length} registros cargados
              </p>
            `;
          }

          // Save to localStorage
          localStorage.setItem('successShortDatabase', JSON.stringify(dataToImport));

          // Update global variable
          successDatabase = dataToImport;

          // Refresh UI
          renderSuccessDatabase();
          updateDbStats();

          statusDiv.style.display = 'block';
          statusDiv.style.background = 'rgba(46, 213, 115, 0.1)';
          statusDiv.style.border = '1px solid #2ed573';
          setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);

        } catch (error) {
          statusDiv.style.display = 'block';
          statusDiv.style.background = 'rgba(255, 71, 87, 0.1)';
          statusDiv.style.border = '1px solid #ff4757';
          statusDiv.innerHTML = `<p style="color: #ff4757; margin: 0;">âŒ Error al importar: ${error.message}</p>`;
          setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }
      };

      reader.onerror = function() {
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(255, 71, 87, 0.1)';
        statusDiv.style.border = '1px solid #ff4757';
        statusDiv.innerHTML = '<p style="color: #ff4757; margin: 0;">âŒ Error al leer el archivo</p>';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
      };

      reader.readAsText(file);

      // Reset file input
      event.target.value = '';
    }

    // Update database stats
    function updateDbStats() {
      const successDatabase = JSON.parse(localStorage.getItem('successShortDatabase') || '[]');
      document.getElementById('dbTotalCount').textContent = successDatabase.length;

      if (successDatabase.length > 0) {
        const avgChange = successDatabase.reduce((sum, s) => sum + (s.change24h || 0), 0) / successDatabase.length;
        document.getElementById('dbAvgChange').textContent = '+' + avgChange.toFixed(1) + '%';

        const rsiAlerts = successDatabase.filter(s => s.analysis && s.analysis.rsi !== null);
        if (rsiAlerts.length > 0) {
          const avgRSI = rsiAlerts.reduce((sum, s) => sum + s.analysis.rsi, 0) / rsiAlerts.length;
          document.getElementById('dbAvgRSI').textContent = avgRSI.toFixed(0);
        }

        const volSpikeAlerts = successDatabase.filter(s => s.analysis && s.analysis.volumeSpike !== null);
        if (volSpikeAlerts.length > 0) {
          const avgVolSpike = volSpikeAlerts.reduce((sum, s) => sum + s.analysis.volumeSpike, 0) / volSpikeAlerts.length;
          document.getElementById('dbAvgVolSpike').textContent = avgVolSpike.toFixed(1) + 'x';
        }
      }
    }
  </script>
</body>
</html>
