<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ff4757">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ShortAlerts">
  <title>Crypto Short Alerts - Futuros</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 50%, #0f0f1a 100%);
      min-height: 100vh;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.2rem;
      background: linear-gradient(90deg, #ff4757, #ff6b81);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #888;
      font-size: 1rem;
    }

    /* Settings Panel */
    .settings-panel {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }

    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setting-group label {
      font-size: 0.85rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .setting-group input, .setting-group select {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 12px 16px;
      color: #fff;
      font-size: 1rem;
      min-width: 150px;
    }

    .setting-group input:focus, .setting-group select:focus {
      outline: none;
      border-color: #ff4757;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff4757, #ff6b81);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 71, 87, 0.3);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }

    .btn-secondary.active {
      background: rgba(255, 71, 87, 0.2);
      border-color: #ff4757;
      color: #ff4757;
    }

    /* Stats */
    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 12px;
      padding: 20px 25px;
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 180px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .stat-value.danger { color: #ff4757; }
    .stat-value.warning { color: #ffa502; }
    .stat-value.success { color: #2ed573; }

    /* Table */
    .table-container {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .table-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .last-update {
      font-size: 0.85rem;
      color: #888;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 20px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: color 0.3s;
    }

    th:hover {
      color: #ff4757;
    }

    th.sorted {
      color: #ff4757;
    }

    td {
      padding: 18px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 0.95rem;
    }

    tr:hover {
      background: rgba(255, 71, 87, 0.05);
    }

    .symbol {
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .symbol-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff4757, #ff6b81);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .price {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }

    .change-positive {
      color: #2ed573;
      font-weight: 600;
    }

    .change-negative {
      color: #ff4757;
      font-weight: 600;
    }

    .volume {
      color: #ffa502;
    }

    .alert-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    .alert-badge.high {
      background: rgba(255, 71, 87, 0.2);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .alert-badge.medium {
      background: rgba(255, 165, 2, 0.2);
      color: #ffa502;
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .new-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      background: linear-gradient(135deg, #a29bfe, #6c5ce7);
      color: #fff;
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .days-listed {
      font-size: 0.75rem;
      color: #888;
      margin-top: 2px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      background: rgba(255, 71, 87, 0.15);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    /* Alert popup */
    .alert-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #c0392b);
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(255, 71, 87, 0.4);
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }

    .alert-popup.hidden {
      display: none;
    }

    .alert-popup h4 {
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .alert-popup p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .alert-popup .close-alert {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .alert-popup .close-alert:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #ff4757;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .settings-row {
        flex-direction: column;
        align-items: stretch;
      }

      .setting-group input, .setting-group select {
        width: 100%;
      }

      .stats-bar {
        flex-direction: column;
      }

      .stat-card {
        min-width: auto;
      }

      table {
        font-size: 0.85rem;
      }

      th, td {
        padding: 12px 10px;
      }

      .symbol-icon {
        display: none;
      }
    }

    /* Sound toggle */
    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .sound-toggle label {
      font-size: 0.9rem;
      color: #aaa;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.1);
      border-radius: 26px;
      transition: 0.3s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: #ff4757;
    }

    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(24px);
    }

    /* Bot Analyst Section */
    .bot-section {
      background: rgba(20, 20, 30, 0.8);
      border-radius: 16px;
      margin-top: 30px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }

    .bot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      background: linear-gradient(135deg, rgba(108, 92, 231, 0.2), rgba(162, 155, 254, 0.1));
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .bot-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .bot-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .bot-content {
      padding: 25px;
    }

    .saved-alerts-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    .saved-alert-card {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      transition: all 0.3s;
    }

    .saved-alert-card:hover {
      border-color: rgba(108, 92, 231, 0.3);
    }

    .saved-alert-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .saved-alert-symbol {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .saved-alert-time {
      font-size: 0.8rem;
      color: #888;
    }

    .saved-alert-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .saved-stat {
      text-align: center;
    }

    .saved-stat-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .saved-stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 4px;
    }

    .bot-analysis {
      background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(162, 155, 254, 0.05));
      border-radius: 10px;
      padding: 18px;
      border-left: 3px solid #6c5ce7;
    }

    .bot-analysis-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #a29bfe;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bot-analysis-text {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #ddd;
    }

    .bot-analysis-text strong {
      color: #ff4757;
    }

    .bot-analysis-text .positive {
      color: #2ed573;
    }

    .bot-analysis-text .warning {
      color: #ffa502;
    }

    .indicator-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .indicator-tag {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .indicator-tag.bearish {
      background: rgba(255, 71, 87, 0.2);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .indicator-tag.neutral {
      background: rgba(255, 165, 2, 0.2);
      color: #ffa502;
      border: 1px solid rgba(255, 165, 2, 0.3);
    }

    .indicator-tag.info {
      background: rgba(108, 92, 231, 0.2);
      color: #a29bfe;
      border: 1px solid rgba(108, 92, 231, 0.3);
    }

    .save-alert-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(108, 92, 231, 0.2);
      color: #a29bfe;
      border: 1px solid rgba(108, 92, 231, 0.3);
      cursor: pointer;
      transition: all 0.3s;
    }

    .save-alert-btn:hover {
      background: #6c5ce7;
      color: #fff;
    }

    .save-alert-btn.saved {
      background: rgba(46, 213, 115, 0.2);
      color: #2ed573;
      border-color: rgba(46, 213, 115, 0.3);
    }

    .delete-alert-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(255, 71, 87, 0.1);
      color: #ff6b81;
      border: 1px solid rgba(255, 71, 87, 0.2);
      cursor: pointer;
      transition: all 0.3s;
    }

    .delete-alert-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    .empty-bot {
      text-align: center;
      padding: 50px 20px;
      color: #666;
    }

    .empty-bot svg {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    .clear-all-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      background: rgba(255, 71, 87, 0.1);
      color: #ff6b81;
      border: 1px solid rgba(255, 71, 87, 0.2);
      cursor: pointer;
    }

    .clear-all-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    /* Bot Tabs */
    .bot-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(0,0,0,0.3);
    }

    .bot-tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: #888;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 2px solid transparent;
    }

    .bot-tab:hover {
      color: #fff;
      background: rgba(255,255,255,0.05);
    }

    .bot-tab.active {
      color: #a29bfe;
      background: rgba(108, 92, 231, 0.1);
      border-bottom-color: #6c5ce7;
    }

    .bot-tab-content {
      display: none;
    }

    .bot-tab-content.active {
      display: block;
    }

    /* Consult section */
    .consult-section {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .consult-input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .consult-input {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 14px 18px;
      color: #fff;
      font-size: 1rem;
      text-transform: uppercase;
    }

    .consult-input:focus {
      outline: none;
      border-color: #6c5ce7;
    }

    .consult-input::placeholder {
      color: #666;
      text-transform: none;
    }

    .consult-btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .consult-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(108, 92, 231, 0.3);
    }

    .consult-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .consult-result {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 25px;
      display: none;
    }

    .consult-result.active {
      display: block;
    }

    .consult-verdict {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .consult-verdict.positive {
      color: #2ed573;
    }

    .consult-verdict.negative {
      color: #ff4757;
    }

    .consult-verdict.neutral {
      color: #ffa502;
    }

    .pattern-matches {
      margin-top: 20px;
    }

    .pattern-match-title {
      font-size: 0.9rem;
      color: #a29bfe;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .pattern-match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(108, 92, 231, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .pattern-similarity {
      font-weight: 600;
      color: #2ed573;
    }

    /* Success marking */
    .mark-success-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(46, 213, 115, 0.1);
      color: #2ed573;
      border: 1px solid rgba(46, 213, 115, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 8px;
    }

    .mark-success-btn:hover {
      background: #2ed573;
      color: #fff;
    }

    .mark-success-btn.marked {
      background: #2ed573;
      color: #fff;
    }

    /* Database stats */
    .db-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .db-stat {
      background: rgba(0,0,0,0.3);
      padding: 15px 20px;
      border-radius: 10px;
      text-align: center;
      min-width: 120px;
    }

    .db-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #a29bfe;
    }

    .db-stat-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* Success database list */
    .success-db-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .success-db-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(46, 213, 115, 0.05);
      border: 1px solid rgba(46, 213, 115, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .success-db-item-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .success-db-symbol {
      font-weight: 700;
      color: #2ed573;
    }

    .success-db-stats {
      font-size: 0.85rem;
      color: #888;
    }

    .remove-from-db-btn {
      padding: 5px 10px;
      background: rgba(255, 71, 87, 0.1);
      border: none;
      border-radius: 5px;
      color: #ff6b81;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .remove-from-db-btn:hover {
      background: #ff4757;
      color: #fff;
    }

    /* Manual Entry Form */
    .manual-entry-section {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .manual-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(39, 174, 96, 0.05));
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #2ed573;
    }

    .manual-entry-header:hover {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.15), rgba(39, 174, 96, 0.1));
    }

    .toggle-icon {
      transition: transform 0.3s;
    }

    .toggle-icon.open {
      transform: rotate(180deg);
    }

    .manual-entry-form {
      padding: 25px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .manual-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .manual-form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .manual-form-group label {
      font-size: 0.85rem;
      color: #aaa;
    }

    .manual-form-group input {
      text-transform: none;
    }

    .manual-form-note {
      background: rgba(108, 92, 231, 0.1);
      border-radius: 8px;
      padding: 12px 15px;
      font-size: 0.85rem;
      color: #a29bfe;
    }

    .manual-entry-result {
      margin-top: 20px;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      display: none;
    }

    .manual-entry-result.active {
      display: block;
    }

    .manual-entry-result.success {
      border-left: 3px solid #2ed573;
    }

    .manual-entry-result.error {
      border-left: 3px solid #ff4757;
    }

    .historical-analysis {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(39, 174, 96, 0.05));
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
    }

    .historical-analysis-title {
      color: #2ed573;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      font-size: 1rem;
      font-weight: 700;
    }

    .score-badge.high {
      background: linear-gradient(135deg, #ff4757, #c0392b);
      color: #fff;
    }

    .score-badge.medium {
      background: linear-gradient(135deg, #ffa502, #e67e22);
      color: #fff;
    }

    .score-badge.low {
      background: linear-gradient(135deg, #2ed573, #27ae60);
      color: #fff;
    }

    /* New alert indicator */
    .new-alert-indicator {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ff4757, #c0392b);
      padding: 15px 30px;
      border-radius: 30px;
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(255, 71, 87, 0.5);
      cursor: pointer;
      transition: all 0.3s;
      z-index: 100;
    }

    .new-alert-indicator:hover {
      transform: translateX(-50%) scale(1.05);
    }

    .new-alert-indicator.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Crypto Short Alerts</h1>
      <p class="subtitle">Monitoreo de Futuros con alto volumen y variacion >30% en 24h</p>
    </header>

    <!-- Settings -->
    <div class="settings-panel">
      <div class="settings-row">
        <div class="setting-group">
          <label>Variacion minima (%)</label>
          <input type="number" id="minChange" value="30" min="1" max="500">
        </div>
        <div class="setting-group">
          <label>Volumen minimo (USDT)</label>
          <input type="number" id="minVolume" value="50000000" step="1000000">
        </div>
        <div class="setting-group">
          <label>Intervalo (segundos)</label>
          <input type="number" id="refreshInterval" value="30" min="10" max="300">
        </div>
        <div class="setting-group">
          <label>Incluir nuevas</label>
          <select id="includeNew">
            <option value="yes">Si (< 60 dias)</option>
            <option value="no">No</option>
            <option value="only">Solo nuevas</option>
          </select>
        </div>
        <button class="btn btn-primary" id="startBtn" onclick="toggleMonitoring()">
          Iniciar Monitoreo
        </button>
        <div class="sound-toggle">
          <label>Sonido</label>
          <div class="toggle-switch">
            <input type="checkbox" id="soundEnabled" checked>
            <span class="toggle-slider"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Alertas Activas</div>
        <div class="stat-value danger" id="alertCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mayor Subida</div>
        <div class="stat-value success" id="maxGain">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mayor Volumen</div>
        <div class="stat-value warning" id="maxVolume">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Nuevas Listadas</div>
        <div class="stat-value" id="newListingsCount" style="color: #a29bfe;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Estado</div>
        <div class="stat-value" id="statusText">Detenido</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <div class="table-header">
        <span class="table-title">Oportunidades de Short</span>
        <span class="last-update" id="lastUpdate">Sin actualizar</span>
      </div>
      <div id="tableContent">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Presiona "Iniciar Monitoreo" para comenzar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot Analyst Section -->
    <div class="bot-section">
      <div class="bot-header">
        <div class="bot-title">
          <div class="bot-icon">ðŸ¤–</div>
          <span>Bot Analista de Shorts</span>
        </div>
        <button class="clear-all-btn" onclick="clearAllSavedAlerts()">Limpiar Alertas</button>
      </div>
      <div class="bot-content">
        <!-- Tabs -->
        <div class="bot-tabs">
          <button class="bot-tab active" onclick="switchBotTab('alerts')">Alertas Guardadas</button>
          <button class="bot-tab" onclick="switchBotTab('consult')">Consultar Alerta</button>
          <button class="bot-tab" onclick="switchBotTab('database')">Base de Datos Exitosas</button>
        </div>

        <!-- Tab 1: Saved Alerts -->
        <div id="tab-alerts" class="bot-tab-content active">
          <div id="savedAlertsList" class="saved-alerts-list">
            <div class="empty-bot">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <p>Guarda alertas para que el bot las analice</p>
              <p style="font-size: 0.85rem; margin-top: 8px;">Usa el boton "Analizar" en cada alerta de la tabla</p>
            </div>
          </div>
        </div>

        <!-- Tab 2: Consult Alert -->
        <div id="tab-consult" class="bot-tab-content">
          <div class="consult-section">
            <p style="color: #aaa; margin-bottom: 20px;">
              Ingresa el simbolo de una moneda para que el bot la compare con tu base de datos de shorts exitosos y te diga si es buena candidata.
            </p>
            <div class="consult-input-row">
              <input type="text" class="consult-input" id="consultSymbol" placeholder="Ej: BTC, ETH, DOGE..." maxlength="20">
              <button class="consult-btn" id="consultBtn" onclick="consultAlert()">
                Consultar al Bot
              </button>
            </div>
            <div id="consultResult" class="consult-result"></div>
          </div>
          <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-top: 10px;">
            <p style="font-size: 0.85rem; color: #888;">
              <strong style="color: #a29bfe;">Como funciona:</strong> El bot compara los indicadores de la nueva alerta con los patrones de tus shorts exitosos.
              Mientras mas alertas exitosas cargues en la base de datos, mas preciso sera el bot.
            </p>
          </div>
        </div>

        <!-- Tab 3: Success Database -->
        <div id="tab-database" class="bot-tab-content">
          <!-- Manual Entry Form -->
          <div class="manual-entry-section">
            <div class="manual-entry-header" onclick="toggleManualEntry()">
              <span>âž• Cargar Alerta Historica Manualmente</span>
              <span class="toggle-icon" id="manualEntryToggle">â–¼</span>
            </div>
            <div class="manual-entry-form" id="manualEntryForm" style="display: none;">
              <p style="color: #888; font-size: 0.9rem; margin-bottom: 20px;">
                Ingresa los datos de un short exitoso que ya conoces. El bot analizara los indicadores de ese momento y te explicara por que fue bueno.
              </p>
              <div class="manual-form-grid">
                <div class="manual-form-group">
                  <label>Simbolo *</label>
                  <input type="text" id="manualSymbol" placeholder="Ej: DOGE, PEPE, WIF..." class="consult-input">
                </div>
                <div class="manual-form-group">
                  <label>Fecha del Short *</label>
                  <input type="date" id="manualDate" class="consult-input">
                </div>
                <div class="manual-form-group">
                  <label>Hora aproximada</label>
                  <input type="time" id="manualTime" class="consult-input" value="12:00">
                </div>
                <div class="manual-form-group">
                  <label>Cambio 24h en ese momento (%)</label>
                  <input type="number" id="manualChange" placeholder="Ej: 45" class="consult-input" step="0.1">
                </div>
                <div class="manual-form-group">
                  <label>Precio de entrada (opcional)</label>
                  <input type="number" id="manualPrice" placeholder="Ej: 0.00234" class="consult-input" step="any">
                </div>
                <div class="manual-form-group">
                  <label>Ganancia obtenida % (opcional)</label>
                  <input type="number" id="manualProfit" placeholder="Ej: 15" class="consult-input" step="0.1">
                </div>
              </div>
              <div class="manual-form-note">
                <p>ðŸ’¡ <strong>Nota:</strong> El bot buscara datos historicos de Binance para calcular RSI, volumen y otros indicadores de ese momento exacto.</p>
              </div>
              <button class="consult-btn" id="manualAddBtn" onclick="addManualEntry()" style="width: 100%; margin-top: 15px;">
                Analizar y Agregar a Base de Datos
              </button>
              <div id="manualEntryResult" class="manual-entry-result"></div>
            </div>
          </div>

          <div class="db-stats" id="dbStats">
            <div class="db-stat">
              <div class="db-stat-value" id="dbTotalCount">0</div>
              <div class="db-stat-label">Shorts Exitosos</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" id="dbAvgChange">-</div>
              <div class="db-stat-label">Cambio Promedio</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" id="dbAvgRSI">-</div>
              <div class="db-stat-label">RSI Promedio</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" id="dbAvgVolSpike">-</div>
              <div class="db-stat-label">Vol Spike Prom.</div>
            </div>
          </div>
          <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
            Esta es tu base de datos de shorts exitosos. El bot aprende de estos patrones para evaluar nuevas alertas.
          </p>
          <div id="successDbList" class="success-db-list">
            <div class="empty-bot">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <p>No hay shorts exitosos en la base de datos</p>
              <p style="font-size: 0.85rem; margin-top: 8px;">Marca alertas como "Exitosa" para que el bot aprenda</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Alert Popup -->
  <div class="alert-popup hidden" id="alertPopup">
    <button class="close-alert" onclick="closeAlert()">&times;</button>
    <h4 id="alertTitle">Nueva Alerta</h4>
    <p id="alertMessage"></p>
  </div>

  <!-- New alerts indicator -->
  <div class="new-alert-indicator hidden" id="newAlertIndicator" onclick="scrollToTop()">
    Nuevas alertas detectadas
  </div>

  <script>
    // State
    let isMonitoring = false;
    let intervalId = null;
    let previousAlerts = new Set();
    let allCoins = [];

    // Audio context for alerts
    let audioContext = null;

    function playAlertSound() {
      if (!document.getElementById('soundEnabled').checked) return;

      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1100, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.2);

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log('Audio not available');
      }
    }

    function formatNumber(num) {
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function formatPrice(price) {
      const num = parseFloat(price);
      if (num < 0.0001) return num.toFixed(8);
      if (num < 0.01) return num.toFixed(6);
      if (num < 1) return num.toFixed(4);
      if (num < 100) return num.toFixed(3);
      return num.toFixed(2);
    }

    // Cache for active symbols and their listing dates
    let activeSymbols = new Set();
    let symbolOnboardDates = new Map(); // symbol -> onboardDate timestamp
    const TWO_MONTHS_MS = 60 * 24 * 60 * 60 * 1000; // 60 days in milliseconds

    async function fetchActiveSymbols() {
      try {
        // Get exchange info to know which symbols are actively trading
        const response = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
        if (!response.ok) throw new Error('Exchange Info API Error');

        const data = await response.json();

        // Filter only symbols that are TRADING status and are PERPETUAL contracts
        const tradingSymbols = data.symbols.filter(
          s => s.status === 'TRADING' && s.contractType === 'PERPETUAL'
        );

        activeSymbols = new Set(tradingSymbols.map(s => s.symbol));

        // Store onboard dates for each symbol
        tradingSymbols.forEach(s => {
          if (s.onboardDate) {
            symbolOnboardDates.set(s.symbol, s.onboardDate);
          }
        });

        console.log(`Loaded ${activeSymbols.size} active perpetual futures symbols`);
        return true;
      } catch (error) {
        console.error('Error fetching exchange info:', error);
        return false;
      }
    }

    function isNewlyListed(symbol) {
      const onboardDate = symbolOnboardDates.get(symbol);
      if (!onboardDate) return false;

      const now = Date.now();
      const age = now - onboardDate;
      return age <= TWO_MONTHS_MS;
    }

    function getDaysListed(symbol) {
      const onboardDate = symbolOnboardDates.get(symbol);
      if (!onboardDate) return null;

      const now = Date.now();
      const age = now - onboardDate;
      return Math.floor(age / (24 * 60 * 60 * 1000));
    }

    async function fetchFuturesData() {
      try {
        // If we don't have active symbols yet, fetch them first
        if (activeSymbols.size === 0) {
          await fetchActiveSymbols();
        }

        // Binance Futures API - 24hr ticker
        const response = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
        if (!response.ok) throw new Error('API Error');

        const data = await response.json();

        // Filter only actively trading symbols
        const filteredData = data.filter(coin => activeSymbols.has(coin.symbol));

        return filteredData;
      } catch (error) {
        console.error('Error fetching data:', error);
        return null;
      }
    }

    function filterAndSortCoins(data) {
      const minChange = parseFloat(document.getElementById('minChange').value);
      const minVolume = parseFloat(document.getElementById('minVolume').value);
      const includeNew = document.getElementById('includeNew').value;

      // Filter USDT pairs
      let filtered = data.filter(coin => {
        const symbol = coin.symbol;
        const priceChangePercent = parseFloat(coin.priceChangePercent);
        const quoteVolume = parseFloat(coin.quoteVolume);
        const isNew = isNewlyListed(symbol);

        // Must be USDT pair
        if (!symbol.endsWith('USDT')) return false;

        // Handle different modes
        if (includeNew === 'only') {
          // Only show newly listed coins (still apply change/volume filters)
          return isNew && priceChangePercent >= minChange && quoteVolume >= minVolume;
        } else if (includeNew === 'yes') {
          // Show all that meet criteria, plus all new listings with >10% change
          const meetsMainCriteria = priceChangePercent >= minChange && quoteVolume >= minVolume;
          const isNewWithMovement = isNew && priceChangePercent >= 10 && quoteVolume >= 10000000;
          return meetsMainCriteria || isNewWithMovement;
        } else {
          // Don't include new, just apply normal filters
          return priceChangePercent >= minChange && quoteVolume >= minVolume;
        }
      });

      // Sort by change percentage descending
      filtered.sort((a, b) => parseFloat(b.priceChangePercent) - parseFloat(a.priceChangePercent));

      return filtered;
    }

    function renderTable(coins) {
      const container = document.getElementById('tableContent');

      if (coins.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <p>No hay criptomonedas que cumplan los criterios actuales</p>
          </div>
        `;
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th onclick="sortTable('symbol')">Simbolo</th>
              <th onclick="sortTable('price')">Precio</th>
              <th onclick="sortTable('change')" class="sorted">Cambio 24h</th>
              <th onclick="sortTable('high')">Max 24h</th>
              <th onclick="sortTable('low')">Min 24h</th>
              <th onclick="sortTable('volume')">Volumen (USDT)</th>
              <th>Alerta</th>
              <th>Accion</th>
            </tr>
          </thead>
          <tbody>
      `;

      coins.forEach(coin => {
        const symbol = coin.symbol.replace('USDT', '');
        const price = formatPrice(coin.lastPrice);
        const change = parseFloat(coin.priceChangePercent).toFixed(2);
        const high = formatPrice(coin.highPrice);
        const low = formatPrice(coin.lowPrice);
        const volume = formatNumber(parseFloat(coin.quoteVolume));

        const alertLevel = parseFloat(change) >= 50 ? 'high' : 'medium';
        const alertText = parseFloat(change) >= 50 ? 'ALTO RIESGO' : 'OPORTUNIDAD';

        const isNew = isNewlyListed(coin.symbol);
        const daysListed = getDaysListed(coin.symbol);
        const newBadge = isNew ? `<span class="new-badge">NUEVO</span>` : '';
        const daysText = isNew && daysListed !== null ? `<div class="days-listed">${daysListed} dias en Binance</div>` : '';

        html += `
          <tr>
            <td>
              <div class="symbol">
                <div class="symbol-icon">${symbol.substring(0, 2)}</div>
                <div>
                  <div>${symbol}/USDT ${newBadge}</div>
                  ${daysText}
                </div>
              </div>
            </td>
            <td class="price">$${price}</td>
            <td class="change-positive">+${change}%</td>
            <td class="price">$${high}</td>
            <td class="price">$${low}</td>
            <td class="volume">${volume}</td>
            <td><span class="alert-badge ${alertLevel}">${alertText}</span></td>
            <td style="display:flex;gap:8px;">
              <button class="save-alert-btn" onclick="saveAlertForAnalysis('${coin.symbol}')">
                Analizar
              </button>
              <button class="action-btn" onclick="openBinance('${coin.symbol}')">
                Binance
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function updateStats(coins) {
      document.getElementById('alertCount').textContent = coins.length;

      // Count newly listed coins
      const newListings = coins.filter(c => isNewlyListed(c.symbol)).length;
      document.getElementById('newListingsCount').textContent = newListings;

      if (coins.length > 0) {
        const maxGain = Math.max(...coins.map(c => parseFloat(c.priceChangePercent)));
        document.getElementById('maxGain').textContent = '+' + maxGain.toFixed(2) + '%';

        const maxVol = Math.max(...coins.map(c => parseFloat(c.quoteVolume)));
        document.getElementById('maxVolume').textContent = formatNumber(maxVol);
      } else {
        document.getElementById('maxGain').textContent = '-';
        document.getElementById('maxVolume').textContent = '-';
      }
    }

    function checkNewAlerts(coins) {
      const currentSymbols = new Set(coins.map(c => c.symbol));
      let newAlerts = [];

      currentSymbols.forEach(symbol => {
        if (!previousAlerts.has(symbol)) {
          const coin = coins.find(c => c.symbol === symbol);
          if (coin) {
            newAlerts.push(coin);
          }
        }
      });

      if (newAlerts.length > 0 && previousAlerts.size > 0) {
        playAlertSound();
        showAlertPopup(newAlerts[0]);
      }

      previousAlerts = currentSymbols;
    }

    function showAlertPopup(coin) {
      const popup = document.getElementById('alertPopup');
      const symbol = coin.symbol.replace('USDT', '');
      const change = parseFloat(coin.priceChangePercent).toFixed(2);

      document.getElementById('alertTitle').textContent = `Nueva Alerta: ${symbol}`;
      document.getElementById('alertMessage').textContent =
        `${symbol}/USDT subio +${change}% en 24h. Volumen: ${formatNumber(parseFloat(coin.quoteVolume))} USDT`;

      popup.classList.remove('hidden');

      setTimeout(() => {
        popup.classList.add('hidden');
      }, 8000);
    }

    function closeAlert() {
      document.getElementById('alertPopup').classList.add('hidden');
    }

    async function updateData() {
      const data = await fetchFuturesData();

      if (!data) {
        document.getElementById('statusText').textContent = 'Error';
        return;
      }

      allCoins = filterAndSortCoins(data);
      renderTable(allCoins);
      updateStats(allCoins);
      checkNewAlerts(allCoins);

      const now = new Date();
      document.getElementById('lastUpdate').textContent =
        `Ultima actualizacion: ${now.toLocaleTimeString()}`;
    }

    function toggleMonitoring() {
      const btn = document.getElementById('startBtn');
      const status = document.getElementById('statusText');

      if (isMonitoring) {
        // Stop
        clearInterval(intervalId);
        isMonitoring = false;
        btn.textContent = 'Iniciar Monitoreo';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        status.textContent = 'Detenido';
        status.style.color = '#888';
      } else {
        // Start
        const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
        isMonitoring = true;
        btn.textContent = 'Detener Monitoreo';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        status.textContent = 'Activo';
        status.style.color = '#2ed573';

        // Initial fetch
        updateData();

        // Set interval
        intervalId = setInterval(updateData, interval);
      }
    }

    function openBinance(symbol) {
      window.open(`https://www.binance.com/es/futures/${symbol}`, '_blank');
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      document.getElementById('newAlertIndicator').classList.add('hidden');
    }

    // Sort functionality
    let currentSort = { column: 'change', ascending: false };

    function sortTable(column) {
      if (!allCoins.length) return;

      const ascending = currentSort.column === column ? !currentSort.ascending : false;
      currentSort = { column, ascending };

      allCoins.sort((a, b) => {
        let valA, valB;

        switch(column) {
          case 'symbol':
            valA = a.symbol;
            valB = b.symbol;
            return ascending ? valA.localeCompare(valB) : valB.localeCompare(valA);
          case 'price':
            valA = parseFloat(a.lastPrice);
            valB = parseFloat(b.lastPrice);
            break;
          case 'change':
            valA = parseFloat(a.priceChangePercent);
            valB = parseFloat(b.priceChangePercent);
            break;
          case 'high':
            valA = parseFloat(a.highPrice);
            valB = parseFloat(b.highPrice);
            break;
          case 'low':
            valA = parseFloat(a.lowPrice);
            valB = parseFloat(b.lowPrice);
            break;
          case 'volume':
            valA = parseFloat(a.quoteVolume);
            valB = parseFloat(b.quoteVolume);
            break;
          default:
            return 0;
        }

        return ascending ? valA - valB : valB - valA;
      });

      renderTable(allCoins);
    }

    // Format volume input with thousand separators
    document.getElementById('minVolume').addEventListener('blur', function() {
      const val = parseInt(this.value) || 50000000;
      this.value = val;
    });

    // ==================== BOT ANALYST SYSTEM ====================

    // Saved alerts storage
    let savedAlerts = JSON.parse(localStorage.getItem('savedShortAlerts') || '[]');

    // Success database storage (must be initialized before renderSavedAlerts)
    let successDatabase = JSON.parse(localStorage.getItem('successShortDatabase') || '[]');

    // Check if alert is in success database
    function isInSuccessDb(symbol, savedAt) {
      return successDatabase.some(s => s.symbol === symbol && s.savedAt === savedAt);
    }

    // Save alert for analysis
    async function saveAlertForAnalysis(symbol) {
      // Check if already saved
      if (savedAlerts.find(a => a.symbol === symbol)) {
        alert('Esta alerta ya fue guardada');
        return;
      }

      // Find coin data
      const coin = allCoins.find(c => c.symbol === symbol);
      if (!coin) {
        alert('No se encontraron datos de la moneda');
        return;
      }

      // Fetch additional data for analysis
      const klineData = await fetchKlineData(symbol);
      const analysis = await analyzeForShort(coin, klineData);

      const savedAlert = {
        symbol: coin.symbol,
        savedAt: Date.now(),
        price: parseFloat(coin.lastPrice),
        change24h: parseFloat(coin.priceChangePercent),
        high24h: parseFloat(coin.highPrice),
        low24h: parseFloat(coin.lowPrice),
        volume: parseFloat(coin.quoteVolume),
        isNew: isNewlyListed(coin.symbol),
        daysListed: getDaysListed(coin.symbol),
        analysis: analysis
      };

      savedAlerts.unshift(savedAlert);
      localStorage.setItem('savedShortAlerts', JSON.stringify(savedAlerts));
      renderSavedAlerts();

      // Scroll to bot section
      document.querySelector('.bot-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Fetch kline data for technical analysis
    async function fetchKlineData(symbol) {
      try {
        // Get 1h klines for RSI and trend analysis
        const response = await fetch(
          `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=50`
        );
        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        console.error('Error fetching klines:', error);
        return null;
      }
    }

    // Calculate RSI from kline data
    function calculateRSI(klines, period = 14) {
      if (!klines || klines.length < period + 1) return null;

      const closes = klines.map(k => parseFloat(k[4]));
      let gains = 0;
      let losses = 0;

      for (let i = 1; i <= period; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) gains += change;
        else losses += Math.abs(change);
      }

      let avgGain = gains / period;
      let avgLoss = losses / period;

      for (let i = period + 1; i < closes.length; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) + Math.abs(change)) / period;
        }
      }

      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    // Calculate price distance from high
    function calculateDistanceFromHigh(price, high24h) {
      return ((high24h - price) / high24h) * 100;
    }

    // Calculate volume spike
    function calculateVolumeSpike(klines) {
      if (!klines || klines.length < 20) return null;

      const volumes = klines.map(k => parseFloat(k[5]));
      const recentVol = volumes.slice(-4).reduce((a, b) => a + b, 0) / 4;
      const avgVol = volumes.slice(0, -4).reduce((a, b) => a + b, 0) / (volumes.length - 4);

      return recentVol / avgVol;
    }

    // Analyze coin for short opportunity
    async function analyzeForShort(coin, klineData) {
      const change = parseFloat(coin.priceChangePercent);
      const price = parseFloat(coin.lastPrice);
      const high = parseFloat(coin.highPrice);
      const low = parseFloat(coin.lowPrice);
      const volume = parseFloat(coin.quoteVolume);
      const isNew = isNewlyListed(coin.symbol);
      const days = getDaysListed(coin.symbol);

      // Calculate indicators
      const rsi = calculateRSI(klineData);
      const distanceFromHigh = calculateDistanceFromHigh(price, high);
      const volumeSpike = calculateVolumeSpike(klineData);

      // Build analysis
      const indicators = [];
      const reasons = [];
      let shortScore = 0;

      // 1. Analyze price change (overextension)
      if (change >= 100) {
        shortScore += 30;
        indicators.push({ name: 'Pump Extremo', type: 'bearish' });
        reasons.push(`El precio subio <strong>+${change.toFixed(1)}%</strong> en 24h, lo cual representa un pump extremo. Historicamente, subidas mayores al 100% tienden a corregir fuertemente.`);
      } else if (change >= 50) {
        shortScore += 25;
        indicators.push({ name: 'Sobreextension Alta', type: 'bearish' });
        reasons.push(`Una subida del <strong>+${change.toFixed(1)}%</strong> indica sobreextension significativa. El activo esta propenso a toma de ganancias.`);
      } else if (change >= 30) {
        shortScore += 15;
        indicators.push({ name: 'Rally Fuerte', type: 'neutral' });
        reasons.push(`El rally del <strong>+${change.toFixed(1)}%</strong> sugiere momentum alcista que podria estar agotandose.`);
      }

      // 2. Analyze RSI
      if (rsi !== null) {
        if (rsi >= 80) {
          shortScore += 25;
          indicators.push({ name: `RSI ${rsi.toFixed(0)}`, type: 'bearish' });
          reasons.push(`El RSI en <strong>${rsi.toFixed(1)}</strong> indica condicion de sobrecompra extrema. Zona tipica de reversion bajista.`);
        } else if (rsi >= 70) {
          shortScore += 15;
          indicators.push({ name: `RSI ${rsi.toFixed(0)}`, type: 'bearish' });
          reasons.push(`RSI en <strong>${rsi.toFixed(1)}</strong> - territorio de sobrecompra. Aumenta probabilidad de correccion.`);
        } else if (rsi >= 60) {
          shortScore += 5;
          indicators.push({ name: `RSI ${rsi.toFixed(0)}`, type: 'neutral' });
          reasons.push(`RSI en <strong>${rsi.toFixed(1)}</strong> - momentum alcista pero sin sobrecompra extrema.`);
        }
      }

      // 3. Analyze distance from high
      if (distanceFromHigh < 2) {
        shortScore += 20;
        indicators.push({ name: 'Cerca del Maximo', type: 'bearish' });
        reasons.push(`El precio esta a solo <strong>${distanceFromHigh.toFixed(1)}%</strong> del maximo de 24h. Zona de resistencia y posible rechazo.`);
      } else if (distanceFromHigh < 5) {
        shortScore += 10;
        indicators.push({ name: 'Zona Alta', type: 'neutral' });
        reasons.push(`Precio a <strong>${distanceFromHigh.toFixed(1)}%</strong> del maximo. Todavia en zona elevada.`);
      }

      // 4. Analyze volume
      if (volumeSpike !== null && volumeSpike > 3) {
        shortScore += 15;
        indicators.push({ name: 'Volumen Extremo', type: 'bearish' });
        reasons.push(`Volumen <strong>${volumeSpike.toFixed(1)}x</strong> mayor al promedio. Alto volumen en maximos suele indicar climax de compra (distribucion).`);
      } else if (volumeSpike !== null && volumeSpike > 2) {
        shortScore += 10;
        indicators.push({ name: 'Volumen Alto', type: 'neutral' });
        reasons.push(`Volumen <strong>${volumeSpike.toFixed(1)}x</strong> sobre el promedio indica interes elevado.`);
      }

      // 5. New listing analysis
      if (isNew) {
        shortScore += 15;
        indicators.push({ name: `Nuevo (${days}d)`, type: 'info' });
        reasons.push(`<span class="warning">Listado hace solo ${days} dias.</span> Las monedas nuevas tienen alta volatilidad y los pumps iniciales suelen revertir cuando termina el hype.`);
      }

      // 6. Range analysis
      const range24h = ((high - low) / low) * 100;
      if (range24h > 50) {
        shortScore += 10;
        indicators.push({ name: 'Alta Volatilidad', type: 'bearish' });
        reasons.push(`Rango del <strong>${range24h.toFixed(1)}%</strong> en 24h indica volatilidad extrema. Mayor riesgo pero tambien mayor potencial de correccion.`);
      }

      // Calculate final score (max 100)
      shortScore = Math.min(shortScore, 100);

      // Generate summary
      let summary = '';
      if (shortScore >= 70) {
        summary = `<strong>ALTA PROBABILIDAD DE SHORT</strong> - Multiples indicadores confluyen para una posible correccion. Score: ${shortScore}/100`;
      } else if (shortScore >= 50) {
        summary = `<strong>PROBABILIDAD MODERADA</strong> - Hay senales bajistas pero no son extremas. Esperar confirmacion. Score: ${shortScore}/100`;
      } else {
        summary = `<strong>PROBABILIDAD BAJA</strong> - Pocas senales de reversion inmediata. Monitorear. Score: ${shortScore}/100`;
      }

      return {
        score: shortScore,
        rsi: rsi,
        distanceFromHigh: distanceFromHigh,
        volumeSpike: volumeSpike,
        indicators: indicators,
        reasons: reasons,
        summary: summary
      };
    }

    // Render saved alerts
    function renderSavedAlerts() {
      const container = document.getElementById('savedAlertsList');

      if (savedAlerts.length === 0) {
        container.innerHTML = `
          <div class="empty-bot">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <p>Guarda alertas para que el bot las analice</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Usa el boton "Analizar" en cada alerta de la tabla</p>
          </div>
        `;
        return;
      }

      let html = '';

      savedAlerts.forEach((alert, index) => {
        const symbol = alert.symbol.replace('USDT', '');
        const savedDate = new Date(alert.savedAt);
        const scoreClass = alert.analysis.score >= 70 ? 'high' : alert.analysis.score >= 50 ? 'medium' : 'low';
        const newBadge = alert.isNew ? `<span class="new-badge">NUEVO</span>` : '';

        html += `
          <div class="saved-alert-card">
            <div class="saved-alert-header">
              <div>
                <div class="saved-alert-symbol">
                  ${symbol}/USDT ${newBadge}
                  <span class="score-badge ${scoreClass}">${alert.analysis.score}</span>
                </div>
                <div class="saved-alert-time">
                  Guardado: ${savedDate.toLocaleDateString()} ${savedDate.toLocaleTimeString()}
                  ${alert.daysListed ? ` â€¢ ${alert.daysListed} dias en Binance` : ''}
                </div>
              </div>
              <div>
                ${isInSuccessDb(alert.symbol, alert.savedAt)
                  ? `<button class="mark-success-btn marked" disabled>En Base de Datos</button>`
                  : `<button class="mark-success-btn" onclick="markAsSuccess(${index})">Marcar Exitosa</button>`
                }
                <button class="delete-alert-btn" onclick="deleteSavedAlert(${index})">Eliminar</button>
              </div>
            </div>

            <div class="saved-alert-stats">
              <div class="saved-stat">
                <div class="saved-stat-label">Precio</div>
                <div class="saved-stat-value">$${formatPrice(alert.price)}</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Cambio 24h</div>
                <div class="saved-stat-value" style="color:#2ed573">+${alert.change24h.toFixed(2)}%</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">RSI</div>
                <div class="saved-stat-value" style="color:${alert.analysis.rsi >= 70 ? '#ff4757' : '#ffa502'}">
                  ${alert.analysis.rsi ? alert.analysis.rsi.toFixed(1) : 'N/A'}
                </div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Dist. Maximo</div>
                <div class="saved-stat-value">${alert.analysis.distanceFromHigh.toFixed(1)}%</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Volumen</div>
                <div class="saved-stat-value" style="color:#ffa502">${formatNumber(alert.volume)}</div>
              </div>
              <div class="saved-stat">
                <div class="saved-stat-label">Vol Spike</div>
                <div class="saved-stat-value">${alert.analysis.volumeSpike ? alert.analysis.volumeSpike.toFixed(1) + 'x' : 'N/A'}</div>
              </div>
            </div>

            <div class="bot-analysis">
              <div class="bot-analysis-title">
                ðŸ¤– Analisis del Bot
              </div>
              <div class="bot-analysis-text">
                <p style="margin-bottom: 15px;">${alert.analysis.summary}</p>
                <p><strong>Razones para shortear:</strong></p>
                <ul style="margin-left: 20px; margin-top: 8px;">
                  ${alert.analysis.reasons.map(r => `<li style="margin-bottom: 8px;">${r}</li>`).join('')}
                </ul>
              </div>
              <div class="indicator-tags">
                ${alert.analysis.indicators.map(i => `<span class="indicator-tag ${i.type}">${i.name}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Delete a saved alert
    function deleteSavedAlert(index) {
      savedAlerts.splice(index, 1);
      localStorage.setItem('savedShortAlerts', JSON.stringify(savedAlerts));
      renderSavedAlerts();
    }

    // Clear all saved alerts
    function clearAllSavedAlerts() {
      if (confirm('Â¿Seguro que quieres eliminar todas las alertas guardadas?')) {
        savedAlerts = [];
        localStorage.setItem('savedShortAlerts', JSON.stringify(savedAlerts));
        renderSavedAlerts();
      }
    }

    // Load saved alerts on page load
    renderSavedAlerts();

    // ==================== SUCCESS DATABASE SYSTEM ====================

    // Switch bot tabs
    function switchBotTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.bot-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.bot-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Refresh database view if switching to database tab
      if (tabName === 'database') {
        renderSuccessDatabase();
      }
    }

    // Mark alert as successful and add to database
    function markAsSuccess(index) {
      const alert = savedAlerts[index];
      if (!alert) return;

      // Check if already in database
      if (successDatabase.find(s => s.symbol === alert.symbol && s.savedAt === alert.savedAt)) {
        alert('Esta alerta ya esta en la base de datos de exitosas');
        return;
      }

      // Add to success database
      const successEntry = {
        ...alert,
        addedToDbAt: Date.now()
      };

      successDatabase.push(successEntry);
      localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));

      // Re-render
      renderSavedAlerts();
      renderSuccessDatabase();

      // Show confirmation
      const symbol = alert.symbol.replace('USDT', '');
      showNotification(`${symbol} agregado a la base de datos de shorts exitosos`);
    }

    // Remove from success database
    function removeFromSuccessDb(index) {
      successDatabase.splice(index, 1);
      localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));
      renderSuccessDatabase();
    }

    // Render success database
    function renderSuccessDatabase() {
      const container = document.getElementById('successDbList');

      // Update stats
      document.getElementById('dbTotalCount').textContent = successDatabase.length;

      if (successDatabase.length > 0) {
        const avgChange = successDatabase.reduce((sum, s) => sum + s.change24h, 0) / successDatabase.length;
        document.getElementById('dbAvgChange').textContent = '+' + avgChange.toFixed(1) + '%';

        const rsiAlerts = successDatabase.filter(s => s.analysis.rsi !== null);
        if (rsiAlerts.length > 0) {
          const avgRSI = rsiAlerts.reduce((sum, s) => sum + s.analysis.rsi, 0) / rsiAlerts.length;
          document.getElementById('dbAvgRSI').textContent = avgRSI.toFixed(1);
        }

        const volSpikeAlerts = successDatabase.filter(s => s.analysis.volumeSpike !== null);
        if (volSpikeAlerts.length > 0) {
          const avgVolSpike = volSpikeAlerts.reduce((sum, s) => sum + s.analysis.volumeSpike, 0) / volSpikeAlerts.length;
          document.getElementById('dbAvgVolSpike').textContent = avgVolSpike.toFixed(1) + 'x';
        }
      } else {
        document.getElementById('dbAvgChange').textContent = '-';
        document.getElementById('dbAvgRSI').textContent = '-';
        document.getElementById('dbAvgVolSpike').textContent = '-';
      }

      if (successDatabase.length === 0) {
        container.innerHTML = `
          <div class="empty-bot">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <p>No hay shorts exitosos en la base de datos</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Marca alertas como "Exitosa" para que el bot aprenda</p>
          </div>
        `;
        return;
      }

      let html = '';
      successDatabase.forEach((entry, index) => {
        const symbol = entry.symbol.replace('USDT', '');
        const date = new Date(entry.savedAt);

        const profitText = entry.profit ? ` | +${entry.profit}% ganancia` : '';
        const manualBadge = entry.isManual ? '<span style="background: rgba(108, 92, 231, 0.2); color: #a29bfe; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 8px;">MANUAL</span>' : '';

        html += `
          <div class="success-db-item">
            <div class="success-db-item-info">
              <span class="success-db-symbol">${symbol}/USDT ${manualBadge}</span>
              <span class="success-db-stats">
                +${entry.change24h.toFixed(1)}% | RSI: ${entry.analysis.rsi ? entry.analysis.rsi.toFixed(0) : 'N/A'} |
                Score: ${entry.analysis.score} | ${date.toLocaleDateString()}${profitText}
              </span>
            </div>
            <button class="remove-from-db-btn" onclick="removeFromSuccessDb(${index})">Eliminar</button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Consult alert against success database
    async function consultAlert() {
      const input = document.getElementById('consultSymbol');
      const resultDiv = document.getElementById('consultResult');
      const btn = document.getElementById('consultBtn');

      let symbol = input.value.trim().toUpperCase();
      if (!symbol) {
        alert('Ingresa un simbolo');
        return;
      }

      // Add USDT if not present
      if (!symbol.endsWith('USDT')) {
        symbol += 'USDT';
      }

      // Check if we have success patterns to compare
      if (successDatabase.length === 0) {
        resultDiv.innerHTML = `
          <div class="consult-verdict neutral">
            âš ï¸ Base de datos vacia
          </div>
          <p style="color: #888;">
            No hay shorts exitosos en la base de datos para comparar.
            Primero debes agregar alertas exitosas para que el bot pueda aprender de ellas.
          </p>
        `;
        resultDiv.classList.add('active');
        return;
      }

      // Disable button while loading
      btn.disabled = true;
      btn.textContent = 'Analizando...';

      try {
        // Fetch current data for the symbol
        const response = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`);

        if (!response.ok) {
          throw new Error('Simbolo no encontrado');
        }

        const coin = await response.json();

        // Fetch kline data
        const klineData = await fetchKlineData(symbol);

        // Analyze the coin
        const analysis = await analyzeForShort(coin, klineData);

        // Compare with success database patterns
        const comparison = compareWithSuccessPatterns(coin, analysis);

        // Render result
        renderConsultResult(coin, analysis, comparison);

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="consult-verdict negative">
            âŒ Error
          </div>
          <p style="color: #888;">${error.message}. Verifica que el simbolo sea correcto y este listado en Binance Futures.</p>
        `;
        resultDiv.classList.add('active');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Consultar al Bot';
      }
    }

    // Compare new alert with success patterns
    function compareWithSuccessPatterns(coin, analysis) {
      const change = parseFloat(coin.priceChangePercent);
      const rsi = analysis.rsi;
      const volSpike = analysis.volumeSpike;
      const distFromHigh = analysis.distanceFromHigh;

      // Calculate average patterns from success database
      const avgChange = successDatabase.reduce((sum, s) => sum + s.change24h, 0) / successDatabase.length;

      const rsiAlerts = successDatabase.filter(s => s.analysis.rsi !== null);
      const avgRSI = rsiAlerts.length > 0
        ? rsiAlerts.reduce((sum, s) => sum + s.analysis.rsi, 0) / rsiAlerts.length
        : null;

      const volSpikeAlerts = successDatabase.filter(s => s.analysis.volumeSpike !== null);
      const avgVolSpike = volSpikeAlerts.length > 0
        ? volSpikeAlerts.reduce((sum, s) => sum + s.analysis.volumeSpike, 0) / volSpikeAlerts.length
        : null;

      const avgDistFromHigh = successDatabase.reduce((sum, s) => sum + s.analysis.distanceFromHigh, 0) / successDatabase.length;
      const avgScore = successDatabase.reduce((sum, s) => sum + s.analysis.score, 0) / successDatabase.length;

      // Calculate similarity scores for each indicator
      const similarities = [];
      let totalSimilarity = 0;
      let factorCount = 0;

      // Change similarity
      const changeDeviation = Math.abs(change - avgChange) / avgChange;
      const changeSimilarity = Math.max(0, 100 - changeDeviation * 50);
      similarities.push({ name: 'Cambio 24h', value: changeSimilarity, current: `+${change.toFixed(1)}%`, pattern: `+${avgChange.toFixed(1)}%` });
      totalSimilarity += changeSimilarity;
      factorCount++;

      // RSI similarity
      if (rsi !== null && avgRSI !== null) {
        const rsiDeviation = Math.abs(rsi - avgRSI) / avgRSI;
        const rsiSimilarity = Math.max(0, 100 - rsiDeviation * 100);
        similarities.push({ name: 'RSI', value: rsiSimilarity, current: rsi.toFixed(1), pattern: avgRSI.toFixed(1) });
        totalSimilarity += rsiSimilarity;
        factorCount++;
      }

      // Volume spike similarity
      if (volSpike !== null && avgVolSpike !== null) {
        const volDeviation = Math.abs(volSpike - avgVolSpike) / avgVolSpike;
        const volSimilarity = Math.max(0, 100 - volDeviation * 50);
        similarities.push({ name: 'Vol Spike', value: volSimilarity, current: volSpike.toFixed(1) + 'x', pattern: avgVolSpike.toFixed(1) + 'x' });
        totalSimilarity += volSimilarity;
        factorCount++;
      }

      // Distance from high similarity
      const distDeviation = Math.abs(distFromHigh - avgDistFromHigh) / (avgDistFromHigh || 1);
      const distSimilarity = Math.max(0, 100 - distDeviation * 100);
      similarities.push({ name: 'Dist. Maximo', value: distSimilarity, current: distFromHigh.toFixed(1) + '%', pattern: avgDistFromHigh.toFixed(1) + '%' });
      totalSimilarity += distSimilarity;
      factorCount++;

      // Score similarity
      const scoreDeviation = Math.abs(analysis.score - avgScore) / avgScore;
      const scoreSimilarity = Math.max(0, 100 - scoreDeviation * 50);
      similarities.push({ name: 'Score', value: scoreSimilarity, current: analysis.score, pattern: avgScore.toFixed(0) });
      totalSimilarity += scoreSimilarity;
      factorCount++;

      const overallSimilarity = totalSimilarity / factorCount;

      // Find most similar successful shorts
      const patternMatches = successDatabase.map(entry => {
        let matchScore = 0;
        let factors = 0;

        // Compare change
        const changeDiff = Math.abs(change - entry.change24h) / entry.change24h;
        matchScore += Math.max(0, 100 - changeDiff * 50);
        factors++;

        // Compare RSI
        if (rsi !== null && entry.analysis.rsi !== null) {
          const rsiDiff = Math.abs(rsi - entry.analysis.rsi) / entry.analysis.rsi;
          matchScore += Math.max(0, 100 - rsiDiff * 100);
          factors++;
        }

        // Compare score
        const scoreDiff = Math.abs(analysis.score - entry.analysis.score) / entry.analysis.score;
        matchScore += Math.max(0, 100 - scoreDiff * 50);
        factors++;

        return {
          symbol: entry.symbol.replace('USDT', ''),
          similarity: matchScore / factors,
          change: entry.change24h,
          score: entry.analysis.score
        };
      }).sort((a, b) => b.similarity - a.similarity).slice(0, 3);

      return {
        overallSimilarity,
        similarities,
        patternMatches,
        avgScore,
        recommendation: overallSimilarity >= 70 ? 'positive' : overallSimilarity >= 50 ? 'neutral' : 'negative'
      };
    }

    // Render consult result
    function renderConsultResult(coin, analysis, comparison) {
      const resultDiv = document.getElementById('consultResult');
      const symbol = coin.symbol.replace('USDT', '');

      let verdictIcon, verdictText, verdictClass;
      if (comparison.recommendation === 'positive') {
        verdictIcon = 'âœ…';
        verdictText = 'BUENA CANDIDATA PARA SHORT';
        verdictClass = 'positive';
      } else if (comparison.recommendation === 'neutral') {
        verdictIcon = 'âš ï¸';
        verdictText = 'CANDIDATA MODERADA';
        verdictClass = 'neutral';
      } else {
        verdictIcon = 'âŒ';
        verdictText = 'NO COINCIDE CON PATRONES EXITOSOS';
        verdictClass = 'negative';
      }

      let html = `
        <div class="consult-verdict ${verdictClass}">
          ${verdictIcon} ${symbol}/USDT - ${verdictText}
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px;">
          <div class="db-stat">
            <div class="db-stat-value" style="color: ${comparison.overallSimilarity >= 70 ? '#2ed573' : comparison.overallSimilarity >= 50 ? '#ffa502' : '#ff4757'}">${comparison.overallSimilarity.toFixed(0)}%</div>
            <div class="db-stat-label">Similitud</div>
          </div>
          <div class="db-stat">
            <div class="db-stat-value" style="color: #2ed573">+${parseFloat(coin.priceChangePercent).toFixed(1)}%</div>
            <div class="db-stat-label">Cambio 24h</div>
          </div>
          <div class="db-stat">
            <div class="db-stat-value" style="color: ${analysis.rsi >= 70 ? '#ff4757' : '#ffa502'}">${analysis.rsi ? analysis.rsi.toFixed(0) : 'N/A'}</div>
            <div class="db-stat-label">RSI</div>
          </div>
          <div class="db-stat">
            <div class="db-stat-value">${analysis.score}</div>
            <div class="db-stat-label">Score</div>
          </div>
        </div>

        <div class="bot-analysis" style="margin-bottom: 20px;">
          <div class="bot-analysis-title">ðŸ¤– Veredicto del Bot</div>
          <div class="bot-analysis-text">
            ${comparison.overallSimilarity >= 70
              ? `<p><strong class="positive">Esta alerta tiene un ${comparison.overallSimilarity.toFixed(0)}% de similitud con tus shorts exitosos.</strong></p>
                 <p>Los indicadores actuales coinciden bien con los patrones que historicamente te han funcionado. El bot considera que es una <strong>buena oportunidad</strong> basandose en tu historial.</p>`
              : comparison.overallSimilarity >= 50
              ? `<p><strong class="warning">Similitud moderada del ${comparison.overallSimilarity.toFixed(0)}% con tus patrones exitosos.</strong></p>
                 <p>Algunos indicadores coinciden pero otros difieren. Considera esperar mas confirmacion o reducir el tamaÃ±o de la posicion.</p>`
              : `<p><strong style="color:#ff4757">Baja similitud (${comparison.overallSimilarity.toFixed(0)}%) con tus shorts exitosos.</strong></p>
                 <p>Esta alerta no coincide con los patrones que te han funcionado antes. El bot sugiere cautela o buscar otra oportunidad.</p>`
            }
          </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
          <p style="font-size: 0.9rem; font-weight: 600; color: #a29bfe; margin-bottom: 12px;">Comparacion de Indicadores</p>
          <table style="width: 100%; font-size: 0.85rem;">
            <tr style="color: #888;">
              <th style="text-align: left; padding: 8px 0;">Indicador</th>
              <th style="text-align: center;">Actual</th>
              <th style="text-align: center;">Patron Exitoso</th>
              <th style="text-align: right;">Similitud</th>
            </tr>
            ${comparison.similarities.map(s => `
              <tr style="border-top: 1px solid rgba(255,255,255,0.05);">
                <td style="padding: 8px 0;">${s.name}</td>
                <td style="text-align: center; color: #fff;">${s.current}</td>
                <td style="text-align: center; color: #a29bfe;">${s.pattern}</td>
                <td style="text-align: right; color: ${s.value >= 70 ? '#2ed573' : s.value >= 50 ? '#ffa502' : '#ff4757'}">${s.value.toFixed(0)}%</td>
              </tr>
            `).join('')}
          </table>
        </div>

        ${comparison.patternMatches.length > 0 ? `
          <div class="pattern-matches">
            <p class="pattern-match-title">Shorts exitosos mas similares</p>
            ${comparison.patternMatches.map(m => `
              <div class="pattern-match-item">
                <span><strong>${m.symbol}</strong> - +${m.change.toFixed(1)}% (Score: ${m.score})</span>
                <span class="pattern-similarity">${m.similarity.toFixed(0)}% similar</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;

      resultDiv.innerHTML = html;
      resultDiv.classList.add('active');
    }

    // Show notification
    function showNotification(message) {
      const popup = document.getElementById('alertPopup');
      document.getElementById('alertTitle').textContent = 'Exito';
      document.getElementById('alertMessage').textContent = message;
      popup.classList.remove('hidden');
      popup.style.background = 'linear-gradient(135deg, #2ed573, #27ae60)';

      setTimeout(() => {
        popup.classList.add('hidden');
        popup.style.background = '';
      }, 3000);
    }

    // Initialize database view
    renderSuccessDatabase();

    // ==================== MANUAL ENTRY SYSTEM ====================

    // Toggle manual entry form
    function toggleManualEntry() {
      const form = document.getElementById('manualEntryForm');
      const toggle = document.getElementById('manualEntryToggle');

      if (form.style.display === 'none') {
        form.style.display = 'block';
        toggle.classList.add('open');
      } else {
        form.style.display = 'none';
        toggle.classList.remove('open');
      }
    }

    // Fetch historical kline data
    async function fetchHistoricalKlines(symbol, timestamp) {
      try {
        // Get klines from 50 hours before the timestamp to have enough data for RSI
        const startTime = timestamp - (50 * 60 * 60 * 1000);
        const endTime = timestamp + (2 * 60 * 60 * 1000);

        const response = await fetch(
          `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&startTime=${startTime}&endTime=${endTime}&limit=100`
        );

        if (!response.ok) throw new Error('Error obteniendo datos historicos');
        return await response.json();
      } catch (error) {
        console.error('Error fetching historical klines:', error);
        return null;
      }
    }

    // Fetch historical 24h ticker (approximate by using klines)
    async function getHistorical24hData(symbol, timestamp, klines) {
      if (!klines || klines.length < 24) return null;

      // Find the candle closest to our timestamp
      let targetIndex = klines.length - 1;
      for (let i = 0; i < klines.length; i++) {
        if (klines[i][0] >= timestamp) {
          targetIndex = i;
          break;
        }
      }

      // Get data from 24 hours before
      const startIndex = Math.max(0, targetIndex - 24);
      const relevantKlines = klines.slice(startIndex, targetIndex + 1);

      if (relevantKlines.length < 2) return null;

      const high24h = Math.max(...relevantKlines.map(k => parseFloat(k[2])));
      const low24h = Math.min(...relevantKlines.map(k => parseFloat(k[3])));
      const currentClose = parseFloat(relevantKlines[relevantKlines.length - 1][4]);
      const openPrice24hAgo = parseFloat(relevantKlines[0][1]);
      const change24h = ((currentClose - openPrice24hAgo) / openPrice24hAgo) * 100;
      const totalVolume = relevantKlines.reduce((sum, k) => sum + parseFloat(k[5]), 0);

      return {
        high24h,
        low24h,
        currentPrice: currentClose,
        change24h,
        volume: totalVolume
      };
    }

    // Add manual entry
    async function addManualEntry() {
      const symbolInput = document.getElementById('manualSymbol');
      const dateInput = document.getElementById('manualDate');
      const timeInput = document.getElementById('manualTime');
      const changeInput = document.getElementById('manualChange');
      const priceInput = document.getElementById('manualPrice');
      const profitInput = document.getElementById('manualProfit');
      const resultDiv = document.getElementById('manualEntryResult');
      const btn = document.getElementById('manualAddBtn');

      // Validate required fields
      let symbol = symbolInput.value.trim().toUpperCase();
      const dateStr = dateInput.value;

      if (!symbol || !dateStr) {
        resultDiv.innerHTML = '<p style="color: #ff4757;">Por favor completa el simbolo y la fecha.</p>';
        resultDiv.className = 'manual-entry-result active error';
        return;
      }

      // Add USDT if needed
      if (!symbol.endsWith('USDT')) {
        symbol += 'USDT';
      }

      // Parse date and time
      const timeStr = timeInput.value || '12:00';
      const dateTimeStr = `${dateStr}T${timeStr}:00`;
      const timestamp = new Date(dateTimeStr).getTime();

      // Check if date is not in the future
      if (timestamp > Date.now()) {
        resultDiv.innerHTML = '<p style="color: #ff4757;">La fecha no puede ser futura.</p>';
        resultDiv.className = 'manual-entry-result active error';
        return;
      }

      // Disable button
      btn.disabled = true;
      btn.textContent = 'Analizando datos historicos...';

      try {
        // Fetch historical data
        const klines = await fetchHistoricalKlines(symbol, timestamp);

        if (!klines || klines.length < 20) {
          throw new Error('No se encontraron suficientes datos historicos para esta fecha. Intenta con una fecha mas reciente o verifica el simbolo.');
        }

        // Get historical 24h data
        const historical24h = await getHistorical24hData(symbol, timestamp, klines);

        // Calculate RSI from historical data
        const rsi = calculateRSI(klines.slice(0, -1)); // Use candles before the target

        // Calculate volume spike from historical data
        const volumeSpike = calculateVolumeSpike(klines.slice(0, -1));

        // Use user-provided change or calculated one
        const change24h = changeInput.value ? parseFloat(changeInput.value) : (historical24h?.change24h || 0);
        const entryPrice = priceInput.value ? parseFloat(priceInput.value) : (historical24h?.currentPrice || 0);
        const profit = profitInput.value ? parseFloat(profitInput.value) : null;

        // Build coin-like object for analysis
        const historicalCoin = {
          symbol: symbol,
          lastPrice: entryPrice.toString(),
          priceChangePercent: change24h.toString(),
          highPrice: (historical24h?.high24h || entryPrice * 1.1).toString(),
          lowPrice: (historical24h?.low24h || entryPrice * 0.9).toString(),
          quoteVolume: (historical24h?.volume || 50000000).toString()
        };

        // Analyze the historical data
        const analysis = await analyzeForShort(historicalCoin, klines);

        // Create success entry
        const successEntry = {
          symbol: symbol,
          savedAt: timestamp,
          addedToDbAt: Date.now(),
          price: entryPrice,
          change24h: change24h,
          high24h: historical24h?.high24h || entryPrice,
          low24h: historical24h?.low24h || entryPrice,
          volume: historical24h?.volume || 0,
          profit: profit,
          isManual: true,
          isNew: false,
          daysListed: null,
          analysis: analysis
        };

        // Add to database
        successDatabase.push(successEntry);
        localStorage.setItem('successShortDatabase', JSON.stringify(successDatabase));

        // Show result
        const shortSymbol = symbol.replace('USDT', '');
        const dateFormatted = new Date(timestamp).toLocaleDateString();

        resultDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
            <span style="font-size: 2rem;">âœ…</span>
            <div>
              <div style="font-size: 1.2rem; font-weight: 700; color: #2ed573;">${shortSymbol}/USDT agregado exitosamente</div>
              <div style="color: #888; font-size: 0.9rem;">Fecha: ${dateFormatted} ${profit ? `| Ganancia: +${profit}%` : ''}</div>
            </div>
          </div>

          <div class="historical-analysis">
            <div class="historical-analysis-title">
              ðŸ” Analisis Historico - Por que fue buen short:
            </div>
            <div class="bot-analysis-text">
              <p style="margin-bottom: 15px;">
                <strong>Score del momento: ${analysis.score}/100</strong>
                ${analysis.score >= 70 ? ' - Excelente setup' : analysis.score >= 50 ? ' - Buen setup' : ' - Setup moderado'}
              </p>
              <ul style="margin-left: 20px;">
                ${analysis.reasons.map(r => `<li style="margin-bottom: 8px;">${r}</li>`).join('')}
              </ul>
            </div>
            <div class="indicator-tags" style="margin-top: 15px;">
              ${analysis.indicators.map(i => `<span class="indicator-tag ${i.type}">${i.name}</span>`).join('')}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 20px;">
            <div class="db-stat">
              <div class="db-stat-value" style="color: #2ed573">+${change24h.toFixed(1)}%</div>
              <div class="db-stat-label">Cambio 24h</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value" style="color: ${rsi >= 70 ? '#ff4757' : '#ffa502'}">${rsi ? rsi.toFixed(0) : 'N/A'}</div>
              <div class="db-stat-label">RSI</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value">${volumeSpike ? volumeSpike.toFixed(1) + 'x' : 'N/A'}</div>
              <div class="db-stat-label">Vol Spike</div>
            </div>
            <div class="db-stat">
              <div class="db-stat-value">${analysis.score}</div>
              <div class="db-stat-label">Score</div>
            </div>
          </div>
        `;
        resultDiv.className = 'manual-entry-result active success';

        // Clear form
        symbolInput.value = '';
        dateInput.value = '';
        changeInput.value = '';
        priceInput.value = '';
        profitInput.value = '';

        // Refresh database list
        renderSuccessDatabase();

      } catch (error) {
        resultDiv.innerHTML = `
          <p style="color: #ff4757; font-weight: 600;">Error al analizar</p>
          <p style="color: #888; margin-top: 8px;">${error.message}</p>
        `;
        resultDiv.className = 'manual-entry-result active error';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analizar y Agregar a Base de Datos';
      }
    }

    // PWA Install
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallButton();
    });

    function showInstallButton() {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary install-btn';
      btn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        Instalar App
      `;
      btn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:1000;padding:14px 24px;gap:8px;box-shadow:0 10px 40px rgba(255,71,87,0.4);';
      btn.onclick = installApp;
      document.body.appendChild(btn);
    }

    async function installApp() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        document.querySelector('.install-btn')?.remove();
      }
      deferredPrompt = null;
    }

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
